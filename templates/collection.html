{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
<h2>My Collection</h2>
<div class="tabs tabs-boxed">
    {% for set in sets %}
    <a class="tab {% if forloop.first %}tab-active{% endif %}" onclick="showSet('{{ set.name|slugify }}')">{{ set.name }}</a>
    {% endfor %}
</div>
<input type="text" id="search" placeholder="Search cards..." class="input input-bordered w-full my-4" onkeyup="filterCards()">

<form method="post" id="collectionForm">
    {% csrf_token %}
    {{ formset.management_form }}
    {% for set_name, cards in cards_by_set.items %}
    <div id="{{ set_name|slugify }}" class="set-section" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
        <table class="table table-xs table-fixed text-base leading-relaxed text-base-content w-full">
            <thead>
                <tr><th class="px-4 py-2 text-center">Owned</th><th class="px-4 py-2 text-center">Image</th><th class="px-4 py-2 text-center">Name</th><th class="px-4 py-2 text-center">ID</th><th class="px-4 py-2 text-center">Type</th><th class="px-4 py-2 text-center">Rarity</th><th class="px-4 py-2 text-center">Owned Quantity</th><th class="px-4 py-2 text-center">For Trade</th><th class="px-4 py-2 text-center">Wishlist</th></tr>
            </thead>
            <tbody>
                {% for card in cards %}
                {% with owned=owned_dict|get_value:card.id %}
                <tr class="{% if not owned or owned.0 == 0 %}opacity-50 bg-gray-300{% endif %} transition-all duration-200 hover:scale-[1.02] hover:shadow-md hover:opacity-100 hover:bg-base-200 hover:font-bold">
                <td class="text-center">
                    <input type="checkbox" disabled {% if owned and owned.0 > 0 %}checked{% endif %} class="checkbox checkbox-lg" aria-label="Owned status for {{ card.name }}">
                </td>
                    <td class="text-center" >
                        <div class="tooltip" data-tip="{{ card.name }} - {{ card.rarity }} ({{ card.card_set.name }})">
                        {% if card.local_image_small %}
                            <img 
                                src="/media/{{ card.local_image_small }}" 
                                alt="{{ card.name }}" 
                                class="w-25 h-auto rounded shadow-md {% if not owned or owned.0 == 0 %}grayscale{% endif %} hover:scale-105 transition-transform duration-200 hover:grayscale-0 lazyload
                                {% if 'Diamond' in card.rarity %}
                                    {% if card.rarity == 'One Diamond' %}border-2 border-info/50{% elif card.rarity == 'Two Diamond' %}border-2 border-info/70{% elif card.rarity == 'Three Diamond' %}border-2 border-info/90{% elif card.rarity == 'Four Diamond' %}border-2 border-info{% endif %}
                                {% elif 'Star' in card.rarity %}
                                    {% if card.rarity == 'One Star' %}border-2 border-warning/50{% elif card.rarity == 'Two Star' %}border-2 border-warning/70{% elif card.rarity == 'Three Star' %}border-2 border-warning{% endif %}
                                {% elif 'Shiny' in card.rarity %}
                                    {% if card.rarity == 'One Shiny' %}border-2 border-secondary/50{% elif card.rarity == 'Two Shiny' %}border-2 border-secondary{% endif %} hover:shadow-secondary/50
                                {% elif card.rarity == 'Crown' %}
                                    border-2 border-error hover:shadow-error/50
                                {% else %}
                                    border-2 border-neutral
                                {% endif %}"
                                loading="lazy">
                        {% else %}
                            <!-- Placeholder if no image -->
                            <div class="w-25 h-16 bg-base-200 rounded flex items-center justify-center text-xs {% if not owned or owned.0 == 0 %}grayscale{% endif %} hover:grayscale-0">No Img</div>
                        {% endif %}
                    </div>
                    </td>
                    <td class="text-center overflow-hidden truncate">
                        <span class="inline-block transition-transform duration-200 hover:scale-105">
                            {{ card.name }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="inline-block transition-transform duration-200 hover:scale-105">
                            {{ card.tcg_id }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="badge text-xs font-semibold px-2 py-1 rounded-full border border-black
                            {% if card.type == 'Colorless' %}
                                bg-[#D2D0CF] bg-gradient-to-r from-[#D2D0CF] to-[#D2D0CF]/70 text-black
                            {% elif card.type == 'Darkness' %}
                                bg-[#2E7077] bg-gradient-to-r from-[#2E7077] to-[#2E7077]/70 text-white
                            {% elif card.type == 'Dragon' %}
                                bg-[#948F31] bg-gradient-to-r from-[#948F31] to-[#948F31]/70 text-white
                            {% elif card.type == 'Fighting' %}
                                bg-[#B16232] bg-gradient-to-r from-[#B16232] to-[#B16232]/70 text-white
                            {% elif card.type == 'Fire' %}
                                bg-[#D8223B] bg-gradient-to-r from-[#D8223B] to-[#D8223B]/70 text-white
                            {% elif card.type == 'Grass' %}
                                bg-[#3FA129] bg-gradient-to-r from-[#3FA129] to-[#3FA129]/70 text-white
                            {% elif card.type == 'Lightning' %}
                                bg-[#FAC000] bg-gradient-to-r from-[#FAC000] to-[#FAC000]/70 text-black
                            {% elif card.type == 'Metal' %}
                                bg-[#60A1B8] bg-gradient-to-r from-[#60A1B8] to-[#60A1B8]/70 text-black
                            {% elif card.type == 'Psychic' %}
                                bg-[#EF4179] bg-gradient-to-r from-[#EF4179] to-[#EF4179]/70 text-white
                            {% elif card.type == 'Water' %}
                                bg-[#2980EF] bg-gradient-to-r from-[#2980EF] to-[#2980EF]/70 text-white
                            {% else %}
                                bg-neutral bg-gradient-to-r from-neutral to-neutral/70 text-black
                            {% endif %} transition-all duration-200 hover:scale-105 hover:shadow-sm">
                            {{ card.type }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="badge text-xs font-semibold px-2 py-1 rounded-full border border-black
                            {% if 'Diamond' in card.rarity %}
                                badge-info bg-gradient-to-r from-info to-info/70
                            {% elif 'Star' in card.rarity %}
                                badge-warning bg-gradient-to-r from-warning to-warning/70
                            {% elif 'Shiny' in card.rarity %}
                                badge-secondary bg-gradient-to-r from-secondary to-secondary/70
                            {% elif card.rarity == 'Crown' %}
                                badge-error bg-gradient-to-r from-error to-error/70
                            {% else %}
                                badge-neutral bg-gradient-to-r from-neutral to-neutral/70
                            {% endif %} transition-all duration-200 hover:scale-105 hover:shadow-sm">
                            {{ card.rarity }}
                        </span>
                    </td>
                    <td class="text-center">
                        <input 
                            type="number" 
                            min="0" 
                            value="{{ owned.0|default:'0' }}" 
                            class="input input-bordered join-item w-20 text-center" 
                            {% if owned %}name="form-{{ forloop.parentloop.counter0 }}-quantity" id="id_form-{{ forloop.parentloop.counter0 }}-quantity"{% endif %} 
                        />
                    </td>
                    <td class="text-center">
                        <input type="checkbox" name="form-{{ forloop.counter0 }}-for_trade" {% if owned.1 %}checked{% endif %}>
                    </td>
                    <td class="text-center">
                        <button type="button" onclick="addToWishlist('{{ card.id }}')" class="btn btn-sm {% if card.id in wants %}btn-success{% else %}btn-outline{% endif %}">Wishlist</button>
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
    <button type="submit" class="btn btn-primary mt-4">Save Changes</button>
</form>

<script>
    function showSet(setId) {
        document.querySelectorAll('.set-section').forEach(el => el.style.display = 'none');
        document.getElementById(setId).style.display = 'block';
    }
    function filterCards() {
        var input = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('tr').forEach(tr => {
            if (tr.textContent.toLowerCase().includes(input)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    }
    function addToWishlist(cardId) {
        // JS to add (e.g., fetch('/want/add/' + cardId, {method: 'POST'}).then(response => console.log('Added')));
        console.log('Added card ' + cardId + ' to wishlist');
    }
    window.onbeforeunload = function () {
        // Check if form changed (basic; improve with JS library if needed)
        return 'Unsaved changes - leave?';
    };
</script>
{% endblock %}