{% extends "base.html" %}
{% load static %}

{% block title %}Pocket Tracker - Collection{% endblock %}

{% block content %}
<div class="card content-card">
    <div class="card-body">

        <div class="flex flex-col sm:flex-row flex-wrap items-center justify-between gap-4 mb-6 p-4 rounded-lg bg-base-300 border-2 border-neutral shadow-md shadow-neutral">
            <form id="unownedForm" method="get" action="." class="flex items-center gap-2 cursor-pointer">
                <span class="label-text text-sm font-semibold">Show Unowned</span>
                <input type="checkbox" name="show_unowned" value="1" {% if show_unowned %}checked{% endif %} class="checkbox checkbox-primary checkbox-md" onchange="this.form.submit()">
            </form>
        
            <div class="flex flex-wrap gap-4 md:divide-x divide-neutral">

                <div class="flex items-center gap-2 md:pr-4">
                    <span class="text-lg font-medium text-primary sm:hidden">ðŸ’Ž</span>
                    <span class="text-sm font-medium text-primary hidden sm:block">Diamonds ðŸ’Ž</span>
                    <label class="label cursor-pointer gap-1">
                        <span class="label-text text-sm md:text-xs font-bold">1</span>
                        <input type="checkbox" class="checkbox checkbox-primary checkbox-md md:checkbox-sm rarity-filter" data-filter="One Diamond" checked>
                    </label>
                    <label class="label cursor-pointer gap-1">
                        <span class="label-text text-sm md:text-xs font-bold">2</span>
                        <input type="checkbox" class="checkbox checkbox-primary checkbox-md md:checkbox-sm rarity-filter" data-filter="Two Diamond" checked>
                    </label>
                    <label class="label cursor-pointer gap-1">
                        <span class="label-text text-sm md:text-xs font-bold">3</span>
                        <input type="checkbox" class="checkbox checkbox-primary checkbox-md md:checkbox-sm rarity-filter" data-filter="Three Diamond" checked>
                    </label>
                    <label class="label cursor-pointer gap-1">
                        <span class="label-text text-sm md:text-xs font-bold">4</span>
                        <input type="checkbox" class="checkbox checkbox-primary checkbox-md md:checkbox-sm rarity-filter" data-filter="Four Diamond" checked>
                    </label>
                </div>

                <div class="flex items-center gap-2 pr-4">
                    <span class="text-lg font-medium text-secondary sm:hidden">â˜…</span>
                    <span class="text-sm font-medium text-secondary hidden sm:block">Stars â˜…</span>
                    <label class="label cursor-pointer gap-1">
                        <span class="label-text text-sm md:text-xs font-bold">1</span>
                        <input type="checkbox" class="checkbox checkbox-secondary checkbox-md md:checkbox-sm rarity-filter" data-filter="One Star" checked>
                    </label>
                    <label class="label cursor-pointer gap-1">
                        <span class="label-text text-sm md:text-xs font-bold">2</span>
                        <input type="checkbox" class="checkbox checkbox-secondary checkbox-md md:checkbox-sm rarity-filter" data-filter="Two Star" checked>
                    </label>
                    <label class="label cursor-pointer gap-1">
                        <span class="label-text text-sm md:text-xs font-bold">3</span>
                        <input type="checkbox" class="checkbox checkbox-secondary checkbox-md md:checkbox-sm rarity-filter" data-filter="Three Star" checked>
                    </label>
                </div>

                <div class="flex items-center gap-2 pr-4">
                    <span class="text-lg font-medium text-accent sm:hidden">âœ¨</span>
                    <span class="text-sm font-medium text-accent hidden sm:block">Shinies âœ¨</span>
                    <label class="label cursor-pointer gap-1">
                        <span class="label-text text-sm md:text-xs font-bold">1</span>
                        <input type="checkbox" class="checkbox checkbox-accent checkbox-md md:checkbox-sm rarity-filter" data-filter="One Shiny" checked>
                    </label>
                    <label class="label cursor-pointer gap-1">
                        <span class="label-text text-sm md:text-xs font-bold">2</span>
                        <input type="checkbox" class="checkbox checkbox-accent checkbox-md md:checkbox-sm rarity-filter" data-filter="Two Shiny" checked>
                    </label>
                </div>

                <div class="flex items-center gap-2 pr-4">
                    <span class="text-lg font-medium text-error sm:hidden">ðŸ‘‘</span>
                    <span class="text-sm font-medium text-error hidden sm:block">Crown ðŸ‘‘</span>
                    <label class="label cursor-pointer gap-1">
                        <input type="checkbox" class="checkbox checkbox-error checkbox-md md:checkbox-sm rarity-filter" data-filter="Crown" checked>
                    </label>
                </div>
            </div>  
        </div>

        {% if not sorted_sets %}
        <div class="alert alert-info shadow-lg">
            <div>
                <img src="{% static 'images/icons/pokeball-open-favicon.png' %}" alt="Pokeball Logo" class="w-8 h-8 mr-2">Your collection is empty! Head to the tracker to add some cards!
            </div>
        </div>
        {% else %}
        {% for set_obj, items, owned_count, unowned_count, has_unseen in sorted_sets %}
        <div class="mb-8 set-section">
            <div class="flex justify-between items-center mb-4 p-2">
                <h2 class="text-lg md:text-2xl font-semibold flex items-center justify-start flex-wrap">
                    <img src="{{ set_obj.logo.url }}" alt="{{ set_obj.name }} logo" class="h-6 md:h-8 mr-2">
                    {{ set_obj.name }}
                    <span class="ml-2 text-xs md:text-sm text-neutral">({{ owned_count }} Owned {% if show_unowned %} / {{ unowned_count }} Unowned{% endif %})</span>
                    {% if has_unseen %}
                    <img src="{% static 'images/icons/new2.png' %}" alt="New Cards!" class="w-6 h-6 md:w-8 md:h-8 ml-2 md:ml-4 set-unseen-notification-{{ set_obj.id }}">
                    {% endif %}
                </h2>
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <form method="post" data-mark-all-seen-form="{{ set_obj.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="mark_all_seen_{{ set_obj.id }}" value="{% for item in items %}{% if item.collection and not item.collection.is_seen %}{{ item.collection.id }}{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}">
                        <button type="submit" class="btn btn-sm lg:btn-md btn-accent cursor-pointer" {% if not has_unseen %}disabled{% endif %}>Mark Seen</button>
                    </form>
                    <button class="btn btn-sm md:btn-md bg-base-200 toggle-btn cursor-pointer hover:bg-primary hover:text-primary-content" data-target="cards-{{ set_obj.id }}">â–¼</button>
                </div>
            </div>
            <div id="cards-{{ set_obj.id }}" class="flex flex-wrap gap-4 px-4 md:px-6 pb-8 pt-8 md:pt-12 overflow-visible justify-center">
                {% for item in items %}
                {% with rarity_lower=item.card.rarity|lower %}
                <div class="card card-collection w-3/4 sm:w-1/3 md:w-1/4 lg:w-32 bg-base-100 relative card-floating card-interactive{% if item.quantity == 0%}-unowned{% endif %}
                {% if 'diamond' in rarity_lower %}rarity-diamond
                {% elif 'star' in rarity_lower %}rarity-star
                {% elif 'shiny' in rarity_lower %}rarity-shiny
                {% elif 'crown' in rarity_lower %}rarity-crown
                {% endif %}" data-card-id="{{ item.card.id }}" data-rarity="{{ item.card.rarity }}" role="button" tabindex="0">
                {% endwith %}
                    <div class="tooltip" data-tip="{{ item.card.name }} - {{ item.card.rarity }}">
                        {% if item.card.local_image_small %}
                        <figure>
                            <img src="{{ item.card.local_image_small.url }}" alt="{{ item.card.name }}" class="card-small-img w-full h-auto object-cover {% if item.quantity == 0 %}grayscale hover:grayscale-0{% endif %}" data-large-src="{{ item.card.image_base }}/high.png" data-rarity="{{ item.card.rarity }}" loading="lazy">
                        </figure>
                        {% else %}
                        <div class="w-25 h-16 bg-base-200 rounded flex items-center justify-center text-xs">No Img</div>
                        {% endif %}
                        {% if item.collection and not item.collection.is_seen %}
                        <img src="{% static 'images/icons/new2.png' %}" alt="New card!" class="absolute top-[-.75rem] right-[-.75rem] w-8 h-8 z-10" data-unseen-icon>
                        {% endif %}
                        {% if item.collection %}
                        <form method="post" data-mark-seen-form>
                            {% csrf_token %}
                            <input type="hidden" name="mark_seen_{{ item.collection.id }}" value="true">
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% endif %}

        {% if errors %}
            <div class="alert alert-error mt-4">
                {% for error in errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>
<div id="image-modal" class="fixed inset-0 flex items-center justify-center backdrop-blur-md z-50 cursor-pointer hidden">
    <img id="large-image" scr="" alt="Large card image" class="max-w-[75%] max-h-[75%] border-8 shadow-2xl rounded-xl">
</div>

<script>
    const smallImages = document.querySelectorAll('.card-small-img');
    const imageModal = document.getElementById('image-modal');
    const largeImage = document.getElementById('large-image');

    smallImages.forEach(img => {
        img.addEventListener('click', function(e) {
            if (e.target.closest('form')) return;

            const largeSrc = img.dataset.largeSrc;
            if (largeSrc) {
                largeImage.src = largeSrc;
                largeImage.alt = img.alt;
                imageModal.classList.remove('hidden');
                imageModal.classList.add('visible')
            
                rarity = img.dataset.rarity.toLowerCase();
                if (rarity.includes('diamond')) {
                    largeImage.classList.add('border-[oklch(74%_.16_232.661)]');
                    largeImage.classList.add('shadow-[oklch(74%_.16_232.661)]');
                } else if (rarity.includes('star')) {
                    largeImage.classList.add('border-[oklch(82%_.189_84.429)]');
                    largeImage.classList.add('shadow-[oklch(82%_.189_84.429)]');
                } else if (rarity.includes('shiny')) {
                    largeImage.classList.add('border-[oklch(65%_.241_354.308)]');
                    largeImage.classList.add('shadow-[oklch(65%_.241_354.308)]');
                } else if (rarity.includes('crown')) {
                    largeImage.classList.add('border-[oklch(71%_.194_13.428)]');
                    largeImage.classList.add('shadow-[oklch(71%_.194_13.428)]');
                } else {
                    largeImage.classList.add('border-neutral');
                    largeImage.classList.add('shadow-neutral');
                }
            }
        });
    });

    imageModal.addEventListener('click', (event) => {
        if (event.target === imageModal) {
            imageModal.classList.add('hidden');
            largeImage.src = '';
            
            const rarityClasses = [
                'border-[oklch(74%_.16_232.661)]', 'shadow-[oklch(74%_.16_232.661)]',  // Diamond
                'border-[oklch(82%_.189_84.429)]', 'shadow-[oklch(82%_.189_84.429)]',  // Star
                'border-[oklch(65%_.241_354.308)]', 'shadow-[oklch(65%_.241_354.308)]',  // Shiny
                'border-[oklch(71%_.194_13.428)]', 'shadow-[oklch(71%_.194_13.428)]',  // Crown
                'border-neutral', 'shadow-neutral'  // Fallback
            ];

            rarityClasses.forEach(className => {
                largeImage.classList.remove(className);
            });
        }
    });

    document.querySelectorAll('.toggle-btn').forEach(button => {
        const targetId = button.dataset.target;
        const cardsDiv = document.getElementById(targetId);
        const storageKey = `collapsed_${targetId}`;

        const isCollapsed = localStorage.getItem(storageKey) === 'true';
        if (isCollapsed) {
            cardsDiv.classList.add('hidden')
            button.textContent = 'â–²';
        } else {
            cardsDiv.classList.remove('hidden')
            button.textContent = 'â–¼';
        }

        button.addEventListener('click', function() {
            cardsDiv.classList.toggle('hidden');

            if (cardsDiv.classList.contains('hidden')) {
                this.textContent = 'â–²';
                localStorage.setItem(storageKey, 'true');
            } else {
                this.textContent = 'â–¼';
                localStorage.setItem(storageKey, 'false');
            }
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const filters = document.querySelectorAll('.rarity-filter');
        const storageKey = 'rarityFilterStates';

        function applyFilters() {
            const visibilityMap = {};
            filters.forEach(filter => {
                visibilityMap[filter.dataset.filter] = filter.checked;
            });

            const allCards = document.querySelectorAll('.card-collection');
            allCards.forEach(card => {
                const isVisible = visibilityMap[card.dataset.rarity] ?? true;
                card.classList.toggle('hidden', !isVisible);
            })

            const visibleCards = document.querySelectorAll('.card-collection:not(.hidden)')
            visibleCards.forEach(card => {
                card.classList.remove('card-floating');
                setTimeout(() => {
                    card.classList.add('card-floating');
                }, 0);
            });
        }

        const savedStates = JSON.parse(localStorage.getItem(storageKey)) || {};
        filters.forEach(filter => {
            const rarity = filter.dataset.filter;
            if (savedStates.hasOwnProperty(rarity)) {
                filter.checked = savedStates[rarity]
            }

            filter.addEventListener('change', () => {
                applyFilters();
                savedStates[rarity] = filter.checked;
                localStorage.setItem(storageKey, JSON.stringify(savedStates));
            });
        });

        applyFilters();
    });

    function markCardAsSeen(form, icon) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.href);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');

        xhr.onload = function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.status === 'success') {
                    const isBulk = !!form.dataset.markAllSeenForm;
                    const setId = isBulk ? form.dataset.markAllSeenForm : null;
                    if (isBulk && setId) {
                        document.querySelectorAll(`#cards-${setId} [data-unseen-icon]`).forEach(icon => icon.remove());
                    } else if (icon) {
                        icon.remove();
                    }

                    const badge = document.querySelector('.unseen-notification-badge');
                    const tooltip = document.querySelector('.unseen-tooltip');
                    const unseenCount = response.unseen_count;
                    const respSetId = response.set_id;
                    const setIcon = document.querySelector(`.set-unseen-notification-${respSetId}`);
                    const markAllButton = document.querySelector(`[data-mark-all-seen-form="${respSetId}"] button`);
                    const hasUnseen = response.has_unseen;

                    if (setIcon && markAllButton && !hasUnseen) {
                        setIcon.remove();
                        markAllButton.disabled = true;
                    }

                    if (tooltip && badge) {
                        if (unseenCount > 0) {
                            tooltip.dataset.tip = `${unseenCount} New Cards!`;
                        } else {
                            tooltip.classList.remove('tooltip');
                            tooltip.classList.remove('unseen-tooltip');
                            badge.remove();
                        }
                    }
                } else {
                    console.error('Error:', response.errors);
                }
            } else {
                console.error('Request failed with status:', xhr.status);
            }
        };
        xhr.send(new FormData(form));
    }

    document.querySelectorAll('.card-collection').forEach(card => {
        card.addEventListener('mouseenter', function () {
            const form = this.querySelector('[data-mark-seen-form]');
            const icon = this.querySelector('[data-unseen-icon]');

            if (form && icon) {
                markCardAsSeen(form, icon);
            }
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[data-mark-all-seen-form]').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const setId = form.dataset.markAllSeenForm;
                markCardAsSeen(form, null);
            });
        });
    });
</script>
{% endblock %}