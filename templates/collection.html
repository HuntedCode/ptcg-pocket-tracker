{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
<h2>My Collection</h2>
<div class="tabs tabs-boxed">
    {% for set in sets %}
    <a class="tab {% if forloop.first %}tab-active{% endif %}" onclick="showSet('{{ set.name|slugify }}')">{{ set.name }}</a>
    {% endfor %}
</div>
<input type="text" id="search" placeholder="Search cards..." class="input input-bordered w-full my-4" onkeyup="filterCards()">

<form method="post" id="collectionForm">
    {% csrf_token %}
    {{ formset.management_form }}
    {% for set_name, cards in cards_by_set.items %}
    <div id="{{ set_name|slugify }}" class="set-section" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
        <table class="table table-zebra">
            <thead>
                <tr><th>Image</th><th>Name</th><th>ID</th><th>Type</th><th>Rarity</th><th>Owned Quantity</th><th>For Trade</th><th>Wishlist</th></tr>
            </thead>
            <tbody>
                {% for card in cards %}
                {% with owned=owned_dict|get_value:card.id %}
                <tr class="{% if not owned %}text-gray-500{% endif %}">
                    <td>
                        <div class="tooltip" data-tip="{{ card.name }} - {{ card.rarity }} ({{ card.card_set.name }})">
                        {% if card.local_image_small %}
                            <img 
                                src="/media/{{ card.local_image_small }}" 
                                alt="{{ card.name }}" 
                                class="w-25 h-auto rounded shadow-md hover:scale-105 transition-transform duration-200 lazyload
                                {% if 'Diamond' in card.rarity %}
                                    {% if card.rarity == 'One Diamond' %}border-2 border-info/50{% elif card.rarity == 'Two Diamond' %}border-2 border-info/70{% elif card.rarity == 'Three Diamond' %}border-2 border-info/90{% elif card.rarity == 'Four Diamond' %}border-2 border-info{% endif %}
                                {% elif 'Star' in card.rarity %}
                                    {% if card.rarity == 'One Star' %}border-2 border-warning/50{% elif card.rarity == 'Two Star' %}border-2 border-warning/70{% elif card.rarity == 'Three Star' %}border-2 border-warning{% endif %}
                                {% elif 'Shiny' in card.rarity %}
                                    {% if card.rarity == 'One Shiny' %}border-2 border-secondary/50{% elif card.rarity == 'Two Shiny' %}border-2 border-secondary{% endif %} hover:shadow-secondary/50
                                {% elif card.rarity == 'Crown' %}
                                    border-2 border-error hover:shadow-error/50
                                {% else %}
                                    border-2 border-neutral
                                {% endif %}"
                                loading="lazy">
                        {% else %}
                            <!-- Placeholder if no image -->
                            <div class="w-25 h-16 bg-base-200 rounded flex items-center justify-center text-xs">No Img</div>
                        {% endif %}
                    </div>
                    </td>
                    <td>{{ card.name }}</td>
                    <td>{{ card.tcg_id }}</td>
                    <td>{{ card.types }}</td>
                    <td>
                        <span class="badge text-xs font-semibold px-2 py-1 rounded-full border border-black
                            {% if 'Diamond' in card.rarity %}
                                badge-info bg-gradient-to-r from-info to-info/70
                            {% elif 'Star' in card.rarity %}
                                badge-warning bg-gradient-to-r from-warning to-warning/70
                            {% elif 'Shiny' in card.rarity %}
                                badge-secondary bg-gradient-to-r from-secondary to-secondary/70
                            {% elif card.rarity == 'Crown' %}
                                badge-error bg-gradient-to-r from-error to-error/70
                            {% else %}
                                badge-neutral bg-gradient-to-r from-neutral to-neutral/70
                            {% endif %}">
                            {{ card.rarity }}
                        </span>
                    </td>
                    <td>
                        <input type="number" name="form-{{ forloop.counter0 }}-quantity" value="{{ owned.0|default:0 }}" min="0" class="input input-bordered w-20">
                    </td>
                    <td>
                        <input type="checkbox" name="form-{{ forloop.counter0 }}-for_trade" {% if owned.1 %}checked{% endif %}>
                    </td>
                    <td>
                        <button type="button" onclick="addToWishlist('{{ card.id }}')" class="btn btn-sm {% if card.id in wants %}btn-success{% else %}btn-outline{% endif %}">Wishlist</button>
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
    <button type="submit" class="btn btn-primary mt-4">Save Changes</button>
</form>

<script>
    function showSet(setId) {
        document.querySelectorAll('.set-section').forEach(el => el.style.display = 'none');
        document.getElementById(setId).style.display = 'block';
    }
    function filterCards() {
        var input = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('tr').forEach(tr => {
            if (tr.textContent.toLowerCase().includes(input)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    }
    function addToWishlist(cardId) {
        // JS to add (e.g., fetch('/want/add/' + cardId, {method: 'POST'}).then(response => console.log('Added')));
        console.log('Added card ' + cardId + ' to wishlist');
    }
    window.onbeforeunload = function () {
        // Check if form changed (basic; improve with JS library if needed)
        return 'Unsaved changes - leave?';
    };
</script>
{% endblock %}