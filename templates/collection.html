{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
<h2>My Collection</h2>
<div class="tabs tabs-boxed">
    {% for set in sets %}
    <a class="tab {% if forloop.first %}tab-active{% endif %}" onclick="showSet('{{ set.name|slugify }}')">{{ set.name }}</a>
    {% endfor %}
</div>
<input type="text" id="search" placeholder="Search cards..." class="input input-bordered w-full my-4 sticky" onkeyup="filterCards()">

<form method="post" id="collectionForm">
    {% csrf_token %}
    {{ formset.management_form }}
    {% for set_name, cards in cards_by_set.items %}
    <div id="{{ set_name|slugify }}" class="set-section" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
        <table class="table table-xs table-fixed text-base leading-relaxed text-base-content w-full">
            <thead class="sticky top-0 bg-base-200 z-10 shadow-md">
                <tr><th class="sticky top-0 z-10 bg-base-100 text-center">Owned</span></th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Image</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center cursor-pointer" onclick="sortTable(this, 2)" data-sort-dir="asc">Name <span class="icon"></span></th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center cursor-pointer" onclick="sortTable(this, 3)" data-sort-dir="asc">ID <span class="icon"></span></th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Type</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Rarity</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Owned Quantity</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">For Trade</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Wishlist</th></tr>
            </thead>
            <tbody>
                {% for card in cards %}
                {% with owned=owned_dict|get_value:card.id %}
                <tr class="{% if not owned or owned.0 == 0 %}opacity-50 bg-gray-300{% endif %} transition-all duration-200 hover:scale-[1.02] hover:shadow-md hover:opacity-100 hover:bg-base-200 hover:font-bold">
                <td class="text-center">
                    <input type="checkbox" disabled {% if owned and owned.0 > 0 %}checked{% endif %} class="checkbox checkbox-lg" aria-label="Owned status for {{ card.name }}">
                </td>
                    <td class="text-center" >
                        <div class="tooltip" data-tip="{{ card.name }} - {{ card.rarity }} ({{ card.card_set.name }})">
                        {% if card.local_image_small %}
                            <img 
                                src="/media/{{ card.local_image_small }}" 
                                alt="{{ card.name }}" 
                                class="w-35 h-auto rounded shadow-md {% if not owned or owned.0 == 0 %}grayscale{% endif %} hover:scale-105 transition-transform duration-200 hover:grayscale-0 lazyload
                                {% if 'Diamond' in card.rarity %}
                                    {% if card.rarity == 'One Diamond' %}border-2 border-info/50{% elif card.rarity == 'Two Diamond' %}border-2 border-info/70{% elif card.rarity == 'Three Diamond' %}border-2 border-info/90{% elif card.rarity == 'Four Diamond' %}border-2 border-info{% endif %}
                                {% elif 'Star' in card.rarity %}
                                    {% if card.rarity == 'One Star' %}border-2 border-warning/50{% elif card.rarity == 'Two Star' %}border-2 border-warning/70{% elif card.rarity == 'Three Star' %}border-2 border-warning{% endif %}
                                {% elif 'Shiny' in card.rarity %}
                                    {% if card.rarity == 'One Shiny' %}border-2 border-secondary/50{% elif card.rarity == 'Two Shiny' %}border-2 border-secondary{% endif %} hover:shadow-secondary/50
                                {% elif card.rarity == 'Crown' %}
                                    border-2 border-error hover:shadow-error/50
                                {% else %}
                                    border-2 border-neutral
                                {% endif %}"
                                loading="lazy">
                        {% else %}
                            <!-- Placeholder if no image -->
                            <div class="w-25 h-16 bg-base-200 rounded flex items-center justify-center text-xs">No Img</div>
                        {% endif %}
                    </div>
                    </td>
                    <td class="text-center overflow-hidden truncate">
                        <span class="inline-block transition-transform duration-200 hover:scale-105 text-lg font-semibold">
                            {{ card.name }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="inline-block transition-transform duration-200 hover:scale-105 text-lg font-semibold tracking-wide">
                            {{ card.tcg_id }}
                        </span>
                    </td>
                    <td class="text-center">
                        {% if card.type %}
                        <div class="tooltip" data-tip="{{ card.type }}">
                            <img 
                                src="/media/icons/energy/{{ card.type|lower }}.png" 
                                alt="{{ card.type }} Energy Symbol" 
                                class="w-12 h-12 transition-all duration-200 hover:scale-110 hover:shadow-sm" 
                                loading="lazy">
                        </div>
                        {% else %}
                        <span class="inline-block transition-transform duration-200 hover:scale-105 text-lg font-semibold">
                            No Type
                        </span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <span class="badge text-xs font-semibold px-2 py-1 rounded-full border border-black
                            {% if 'Diamond' in card.rarity %}
                                badge-info bg-gradient-to-r from-info to-info/70
                            {% elif 'Star' in card.rarity %}
                                badge-warning bg-gradient-to-r from-warning to-warning/70
                            {% elif 'Shiny' in card.rarity %}
                                badge-secondary bg-gradient-to-r from-secondary to-secondary/70
                            {% elif card.rarity == 'Crown' %}
                                badge-error bg-gradient-to-r from-error to-error/70
                            {% else %}
                                badge-neutral bg-gradient-to-r from-neutral to-neutral/70
                            {% endif %} transition-all duration-200 hover:scale-105 hover:shadow-sm">
                            {{ card.rarity }}
                        </span>
                    </td>
                    <td class="text-center">
                        <input 
                            type="number" 
                            min="0" 
                            value="{{ owned.0|default:'0' }}" 
                            class="input input-bordered join-item w-20 text-center" 
                            {% if owned %}name="form-{{ forloop.parentloop.counter0 }}-quantity" id="id_form-{{ forloop.parentloop.counter0 }}-quantity"{% endif %} 
                        />
                    </td>
                    <td class="text-center">
                        <input type="checkbox" name="form-{{ forloop.counter0 }}-for_trade" class="checkbox checkbox-lg" {% if owned.1 %}checked{% endif %}>
                    </td>
                    <td class="text-center">
                        <button type="button" onclick="addToWishlist('{{ card.id }}')" class="btn btn-sm {% if card.id in wants %}btn-success{% else %}btn-outline{% endif %}">Wishlist</button>
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>  
    </div>
    {% endfor %}
    <button type="submit" class="btn btn-primary mt-4">Save Changes</button>
</form>

<script>
    function showSet(setId) {
        document.querySelectorAll('.set-section').forEach(el => el.style.display = 'none');
        document.getElementById(setId).style.display = 'block';
    }
    function filterCards() {
        var input = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('tr').forEach(tr => {
            if (tr.textContent.toLowerCase().includes(input)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    }
    function addToWishlist(cardId) {
        console.log('Added card ' + cardId + ' to wishlist');
    }
function sortTable(header, colIndex) {
    const table = header.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    const allHeaders = table.querySelectorAll('th.cursor-pointer');
    allHeaders.forEach(h => {
        if (h !== header) {
            h.querySelector('.icon').innerHTML = '';
            h.dataset.sortDir = 'asc';
        }
    });
    
    let dir = header.dataset.sortDir === 'asc' ? 1 : -1;
    header.dataset.sortDir = dir === 1 ? 'desc' : 'asc';
    
    rows.sort((a, b) => {
        let valA = a.cells[colIndex].dataset.sortValue || a.cells[colIndex].textContent.trim();
        let valB = b.cells[colIndex].dataset.sortValue || b.cells[colIndex].textContent.trim();
        if (!isNaN(valA) && !isNaN(valB)) {
            return dir * (parseFloat(valA) - parseFloat(valB));
        } else {
            return dir * valA.localeCompare(valB);
        }
    });
    
    rows.forEach(row => tbody.appendChild(row));
    
    header.querySelector('.icon').innerHTML = dir === 1 ? '&#x25B2;' : '&#x25BC;';
}
    window.onbeforeunload = function () {
        return 'Unsaved changes - leave?';
    };
</script>
{% endblock %}