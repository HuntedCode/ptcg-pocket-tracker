{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4">
    
    <form method="get" class="mb-4">
        <label class="lable cursor-pointer">
            <span class="label-text">Show Unowned Cards</span>
            <input type="checkbox" name="show_unowned" value="1" {% if show_unowned %}checked{% endif %} class="checkbox checkbox-primary" onchange="this.form.submit()">
        </label>
    </form>

    {% if not sorted_sets %}
    <div class="alert alert-info shadow-lg">
        <div>
            <img src="{% static 'images/icons/pokeball-open-favicon.png' %}" alt="Pokeball Logo" class="w-8 h-8 mr-2">Your collection is empty! Head to the tracker to add some cards!
        </div>
    </div>
    {% else %}
    {% for set_obj, items, owned_count, unowned_count in sorted_sets %}
    <div class="mb-8 set-section">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold mb-4 flex items-center">
                <img src="/media/{{ set_obj.logo_path }}" alt="{{ set_obj.name }} logo" class="h-8 mr-2">
                {{ set_obj.name }}
                <span class="ml-2 text-sm text-gray-500">({{ owned_count }} Owned Cards{% if show_unowned %} / {{ unowned_count }} Unowned Cards{% endif %})</span>
            </h2>
            <button class="btn btn-sm bg-base-200 toggle-btn hover:bg-primary hover:text-primary-content" data-target="cards-{{ set_obj.id }}">▼</button>
        </div>
        <div id="cards-{{ set_obj.id }}" class="flex flex-wrap gap-4 overflow-x-auto px-6 pb-8 pt-12 snap-x snap-mandatory overflow-visible justify-center">
            {% for item in items %}
            {% with rarity_lower=item.card.rarity|lower %}
            <div class="card w-32 bg-base-100 relative card-floating card-interactive 
            {% if 'diamond' in rarity_lower %}rarity-diamond
            {% elif 'star' in rarity_lower %}rarity-star
            {% elif 'shiny' in rarity_lower %}rarity-shiny
            {% elif 'crown' in rarity_lower %}rarity-crown
            {% endif %}" data-card-id="{{ item.card.id }}" role="button" tabindex="0">
            {% endwith %}
                <div class="tooltip" data-tip="{{ item.card.name }} - {{ item.card.rarity }}">
                    <figure>
                        <img src="/media/{{ item.card.local_image_small }}" alt="{{ item.card.name }}" class="card-small-img w-full h-44 object-cover {% if item.quantity == 0 %}grayscale hover:grayscale-0{% endif %}" data-large-src="{{ item.card.image_base }}/high.png" data-rarity="{{ item.card.rarity }}" loading="lazy">
                    </figure>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    {% endif %}

    {% if errors %}
        <div class="alert alert-error mt-4">
            {% for error in errors %}
                <p>{{ error }}</p>
            {% endfor %}
        </div>
    {% endif %}
</div>
<div id="image-modal" class="fixed inset-0 flex items-center justify-center backdrop-blur-md z-50 cursor-pointer hidden">
    <img id="large-image" scr="" alt="Large card image" class="max-w-[75%] max-h-[75%] border-8 shadow-2xl rounded-xl">
</div>

<script>
    const smallImages = document.querySelectorAll('.card-small-img');
    const imageModal = document.getElementById('image-modal');
    const largeImage = document.getElementById('large-image');

    smallImages.forEach(img => {
        img.addEventListener('click', function(e) {
            if (e.target.closest('form')) return;

            const largeSrc = img.dataset.largeSrc;
            if (largeSrc) {
                largeImage.src = largeSrc;
                largeImage.alt = img.alt;
                imageModal.classList.remove('hidden');
                imageModal.classList.add('visible')
            
                rarity = img.dataset.rarity.toLowerCase();
                if (rarity.includes('diamond')) {
                    largeImage.classList.add('border-[oklch(74%_.16_232.661)]');
                    largeImage.classList.add('shadow-[oklch(74%_.16_232.661)]');
                } else if (rarity.includes('star')) {
                    largeImage.classList.add('border-[oklch(82%_.189_84.429)]');
                    largeImage.classList.add('shadow-[oklch(82%_.189_84.429)]');
                } else if (rarity.includes('shiny')) {
                    largeImage.classList.add('border-[oklch(65%_.241_354.308)]');
                    largeImage.classList.add('shadow-[oklch(65%_.241_354.308)]');
                } else if (rarity.includes('crown')) {
                    largeImage.classList.add('border-[oklch(71%_.194_13.428)]');
                    largeImage.classList.add('shadow-[oklch(71%_.194_13.428)]');
                } else {
                    largeImage.classList.add('border-neutral');
                    largeImage.classList.add('shadow-neutral');
                }
            }
        });
    });

    imageModal.addEventListener('click', (event) => {
        if (event.target === imageModal) {
            imageModal.classList.add('hidden');
            largeImage.src = '';
            
            const rarityClasses = [
                'border-[oklch(74%_.16_232.661)]', 'shadow-[oklch(74%_.16_232.661)]',  // Diamond
                'border-[oklch(82%_.189_84.429)]', 'shadow-[oklch(82%_.189_84.429)]',  // Star
                'border-[oklch(65%_.241_354.308)]', 'shadow-[oklch(65%_.241_354.308)]',  // Shiny
                'border-[oklch(71%_.194_13.428)]', 'shadow-[oklch(71%_.194_13.428)]',  // Crown
                'border-neutral', 'shadow-neutral'  // Fallback
            ];

            rarityClasses.forEach(className => {
                largeImage.classList.remove(className);
            });
        }
    });

    document.querySelectorAll('.toggle-btn').forEach(button => {
        console.log(button)

        const targetId = button.dataset.target;
        const cardsDiv = document.getElementById(targetId);
        const storageKey = `collapsed_${targetId}`;

        const isCollapsed = localStorage.getItem(storageKey) === 'true';
        if (isCollapsed) {
            cardsDiv.classList.add('hidden')
            button.textContent = '▲';
        } else {
            cardsDiv.classList.remove('hidden')
            button.textContent = '▼';
        }

        button.addEventListener('click', function() {
            cardsDiv.classList.toggle('hidden');

            if (cardsDiv.classList.contains('hidden')) {
                this.textContent = '▲';
                localStorage.setItem(storageKey, 'true');
            } else {
                this.textContent = '▼';
                localStorage.setItem(storageKey, 'false');
            }
        });
    });
</script>
{% endblock %}