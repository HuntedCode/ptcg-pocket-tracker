{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
{% if errors %}
    <div class="alert alert-error">
        <ul>
            {% for error in errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div class="flex flex-wrap justify-center gap-4 mb-4">
    {% for nav_set in sets %}
    <a role="tab" href="{% url 'tracker' nav_set.id %}" class="flex flex-col items-center justify-center p-2 w-[200px] h-[100px] bg-base-200 border border-neutral rounded-md shadow-md shadow-neutral
                                                                    hover:bg-primary hover:text-primary-content hover:scale-105 transition-all duration-200 
                                                                    {% if nav_set.id == set_id %}bg-primary text-primary-content font-bold{% endif %}">
        <img src="{% static nav_set.logo_path %}" alt="{{ nav_set.name }} logo" class="w-32 h-16 mb-1 object-contain row-span-1">
        <span class="text-center text-sm font-medium row-span-1">{{ nav_set.name }}</span>
    </a>
    {% endfor %}
</div>
<input type="text" id="search" placeholder="Search cards..." class="input input-bordered w-full my-4 sticky" onkeyup="filterCards()">

<form method="post">
    {% csrf_token %}
    <div class="raised-card">
        <table class="table table-md table-fixed text-base leading-relaxed text-base-content">
            <thead class="sticky top-0 bg-base-200 z-10 shadow-md text-lg w-full">
                <tr><th class="sticky top-0 z-10 bg-base-100 text-center">Owned</span></th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Image</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center cursor-pointer" onclick="sortTable(this, 2)" data-sort-dir="asc">Name <span class="icon"></span></th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center cursor-pointer" onclick="sortTable(this, 3)" data-sort-dir="asc">ID <span class="icon"></span></th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Type</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Rarity</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Quantity</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">For Trade</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Wishlist</th>
                    <th class="sticky top-0 z-10 bg-base-100 text-center">Favorite</th>
                </tr>
            </thead>
            <tbody>
                {% for card in cards %}
                {% with owned=owned_dict|get_value:card.id %}
                <tr class="{% if not owned or owned.0 == 0 %}opacity-50 bg-gray-300{% endif %} bg-base-100 pt-20 transition-all duration-200 hover:scale-[1.02] hover:shadow-md hover:opacity-100 hover:bg-base-200 hover:font-bold">
                <td class="text-center">
                    <input type="checkbox" disabled {% if owned and owned.0 > 0 %}checked{% endif %} class="checkbox checkbox-lg" aria-label="Owned status for {{ card.name }}">
                </td>
                    <td class="text-center card-image" >
                        <div class="tooltip" data-tip="{{ card.name }} - {{ card.rarity }}">
                        {% if card.local_image_small %}
                            <img 
                                src="{% static card.local_image_small %}" 
                                alt="{{ card.name }}" 
                                class="card-img w-35 h-auto rounded shadow-md cursor-pointer card-small-img {% if not owned or owned.0 == 0 %}grayscale{% endif %} hover:scale-105 transition-transform duration-200 hover:grayscale-0 lazyload
                                {% if 'Diamond' in card.rarity %}
                                    {% if card.rarity == 'One Diamond' %}border-4 border-[oklch(74%_.16_232.661)]/50{% elif card.rarity == 'Two Diamond' %}border-4 border-[oklch(74%_.16_232.661)]/70{% elif card.rarity == 'Three Diamond' %}border-4 border-[oklch(74%_.16_232.661)]/90{% elif card.rarity == 'Four Diamond' %}border-4 border-[oklch(74%_.16_232.661)]{% endif %} hover: shadow-[oklch(74%_.16_232.661)]/50
                                {% elif 'Star' in card.rarity %}
                                    {% if card.rarity == 'One Star' %}border-4 border-[oklch(82%_.189_84.429)]/70{% elif card.rarity == 'Two Star' %}border-4 border-[oklch(82%_.189_84.429)]/90{% elif card.rarity == 'Three Star' %}border-4 border-[oklch(82%_.189_84.429)]{% endif %} hover: shadow-border-[oklch(82%_.189_84.429)]/50
                                {% elif 'Shiny' in card.rarity %}
                                    {% if card.rarity == 'One Shiny' %}border-4 border-[oklch(65%_.241_354.308)]/70{% elif card.rarity == 'Two Shiny' %}border-4 border-[oklch(65%_.241_354.308)]{% endif %} hover:shadow-[oklch(65%_.241_354.308)]/50
                                {% elif card.rarity == 'Crown' %}
                                    border-4 border-[oklch(71%_.194_13.428)] hover:shadow-[oklch(71%_.194_13.428)]/50
                                {% else %}
                                    border-4 border-neutral
                                {% endif %}"
                                data-large-src="{{ card.image_base }}/high.png"
                                data-rarity="{{ card.rarity }}"
                                loading="lazy">
                        {% else %}
                            <!-- Placeholder if no image -->
                            <div class="w-25 h-16 bg-base-200 rounded flex items-center justify-center text-xs">No Img</div>
                        {% endif %}
                    </div>
                    </td>
                    <td class="text-center overflow-hidden truncate">
                        <span class="inline-block transition-transform duration-200 hover:scale-105 text-lg font-semibold text-wrap">
                            {{ card.name }}
                        </span>
                    </td>
                    <td class="text-center">
                        <span class="inline-block transition-transform duration-200 hover:scale-105 text-lg font-semibold tracking-wide">
                            {{ card.tcg_id }}
                        </span>
                    </td>
                    <td class="text-center">
                        {% if card.type %}
                        <div class="tooltip" data-tip="{{ card.type }}">
                            <img 
                                src="{% static 'images/icons/energy/'|add:card.type|lower|add:'.png' %}" 
                                alt="{{ card.type }} Energy Symbol" 
                                class="w-10 h-10 transition-all duration-200 hover:scale-110 hover:shadow-sm card-img" 
                                loading="lazy">
                        </div>
                        {% else %}
                        <span class="inline-block transition-transform duration-200 hover:scale-105 text-lg font-semibold">
                            No Type
                        </span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="tooltip" data-tip="{{ card.rarity }}">  <!-- Hover shows full name, e.g., "Two Diamond" -->
                            <span class="inline-block text-xl transition-all duration-200 hover:scale-110 hover:shadow-sm text-lg font-semibold text-warning">
                                {% if card.rarity == 'One Diamond' %}ðŸ’Ž
                                {% elif card.rarity == 'Two Diamond' %}ðŸ’ŽðŸ’Ž
                                {% elif card.rarity == 'Three Diamond' %}ðŸ’ŽðŸ’ŽðŸ’Ž
                                {% elif card.rarity == 'Four Diamond' %}ðŸ’ŽðŸ’ŽðŸ’ŽðŸ’Ž
                                {% elif card.rarity == 'One Star' %}â˜…
                                {% elif card.rarity == 'Two Star' %}â˜…â˜…
                                {% elif card.rarity == 'Three Star' %}â˜…â˜…â˜…
                                {% elif card.rarity == 'One Shiny' %}âœ¨
                                {% elif card.rarity == 'Two Shiny' %}âœ¨âœ¨
                                {% elif card.rarity == 'Crown' %}ðŸ‘‘
                                {% else %}{{ card.rarity }}
                                {% endif %}
                            </span>
                        </div>
                    </td>
                    <td class="text-center">
                        <input 
                            type="number" name="quantity_{{ card.id }}" min="0" value="{{ owned.0|default:'0' }}" class="input input-bordered join-item w-20 text-center" 
                        />
                    </td>
                    {% if card.is_tradeable %}
                    <td class="text-center">
                        <button data-card-id="{{ card.id }}" name="for_trade_{{ card.id }}" type="button" class="btn btn-md for-trade-toggle {% if owned.1 %}btn-accent{% else %}btn-outline{% endif %}" {% if not owned or owned.0 < 2 %}disabled{% endif %}>
                            {% if owned.1 %}For Trade!{% else %}Tradeable{% endif %}
                        </button>                        
                    </td>
                    <td class="text-center">
                        <button data-card-id="{{ card.id }}" type="button" class="btn btn-md wishlist-toggle {% if card.id in wants %}btn-success{% else %}btn-outline{% endif %}" {% if owned and owned.0 > 1 %}disabled{% endif %}>
                            {% if card.id in wants %}Wishlisted!{% else %}Wishlist{% endif %}
                        </button>
                    </td>
                    {% else %}
                    <td></td>
                    <td></td>
                    {% endif %}
                    <td class="text-center">
                        <button data-card-id="{{ card.id }}" type="button" class="btn btn-md {% if owned.2 %}btn-primary{% else %}btn-outline{% endif %} favorite-toggle w-full" {% if not owned or owned.0 == 0 %}disabled{% endif %}>
                            {% if owned.2 %}Favorited!{% else %}Favorite{% endif %}
                        </button>
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>
<div id="image-modal" class="fixed inset-0 flex items-center justify-center backdrop-blur-md z-50 cursor-pointer hidden">
    <img id="large-image" scr="" alt="Large card image" class="max-w-[75%] max-h-[75%] border-8 shadow-2xl rounded-xl">
</div>
<div id="save-indicator" class="fixed bottom-4 right-4 px-4 py-2 bg-green-500 text-white rounded shadow-lg hidden transition-opacity duration-3000">
    Saved!
</div>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateRowStyle(quantityInput) {
        if (quantityInput.type !== "number") {
            return;
        }
        const row = quantityInput.closest('tr');
        if (!row) return;
        
        const qtyValue = parseInt(quantityInput.value, 10) || 0;
        const favoriteToggle = row.querySelector('.favorite-toggle');
        if (qtyValue <= 0) {
            row.classList.add('opacity-50', 'bg-gray-300');
            favoriteToggle.disabled = true;
            if (favoriteToggle.classList.contains('btn-primary')) {
                favoriteToggle.classList.remove('btn-primary');
                favoriteToggle.classList.add('btn-outline');
                favoriteToggle.textContent = 'Favorite';
            }
        } else {
            row.classList.remove('opacity-50', 'bg-gray-300');
            favoriteToggle.disabled = false;
        }

        const forTradeToggle = row.querySelector('.for-trade-toggle');
        if (forTradeToggle) {
            if (qtyValue >= 2) {
                forTradeToggle.disabled = false;
            } else {
                forTradeToggle.disabled = true;
                if (forTradeToggle.classList.contains('btn-accent')) {
                    forTradeToggle.classList.remove('btn-accent');
                    forTradeToggle.classList.add('btn-outline');
                    forTradeToggle.textContent = 'Tradeable';
                }
            }
        }

        const wishlistToggle = row.querySelector('.wishlist-toggle');
        if (wishlistToggle) {
            if (qtyValue > 1) {
                wishlistToggle.disabled = true;
                if (wishlistToggle.classList.contains('btn-success')) {
                    wishlistToggle.classList.remove('btn-success');
                    wishlistToggle.classList.add('btn-outline');
                    wishlistToggle.textContent = 'Wishlist';
                }
            } else {
                wishlistToggle.disabled = false;
            }
        }

        const imageTd = row.querySelector('.card-image');
        if (!imageTd) {
            return;
        }

        const image = imageTd.querySelector('img.card-img');
        if (image) {
            if (qtyValue > 0) {
                image.classList.remove('grayscale');
            } else {
                image.classList.add('grayscale');
            }
        } else {
            imageTd.classList.toggle('text-gray-500', qtyValue === 0);
        }
    }
    
    const saveIndicator = document.getElementById('save-indicator');
    if (!saveIndicator) {
    }

    let indicatorTimeout;

    function showIndicator(message, isError = false) {
        if (!saveIndicator) return;
        saveIndicator.textContent = message;
        saveIndicator.classList.toggle('error', isError);
        saveIndicator.classList.remove('hidden'); 
        saveIndicator.style.opacity = '1';

        clearTimeout(indicatorTimeout);
        indicatorTimeout = setTimeout(() => {
            saveIndicator.style.opacity = '0';
            setTimeout(() => {
                saveIndicator.classList.add('hidden');
                saveIndicator.classList.remove('error');
            }, 300);
        }, 2000);
    }

    const inputs = document.querySelectorAll('input[type="number"][name^="quantity_"]');
    const initialValues = new Map();
    inputs.forEach(input => {
        if (input.type === 'number') {
            initialValues.set(input.name, input.value);
        }
    });

    function getChangedData() {
        const changedData = new FormData();
        let hasChanges = false;

        inputs.forEach(input => {
            let currentValue = input.type === 'number' ? input.value : 0;
            let initial = initialValues.get(input.name);

            if (currentValue !== initial) {
                changedData.append(input.name, currentValue);
                hasChanges = true;
            }
        });
        return changedData;
    }

    function saveChanges() {
        const changedData = getChangedData();
        let hasEntries = false;
        for (let pair of changedData.entries()) {
            hasEntries = true;
            break;
        }
        if (!hasEntries) {
            return;
        }

        const csrfToken = getCookie('csrftoken');
        if (!csrfToken) return;

        fetch(window.location.href, {
            method: 'POST',
            body: changedData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                inputs.forEach(input => {
                    initialValues.set(input.name, input.type === 'number' ? input.value : 0);
                });
                showIndicator('Saved!');
            } else {
                alert('Errors: ' + (data.errors ? data.errors.join(', ') : 'Unknown'));
            }
        })
        .catch(error => {
            alert('Save failedâ€”check console.');
        });
    }

    inputs.forEach(input => {
        input.addEventListener('change', () => {
            updateRowStyle(input);
            saveChanges();
        });
    });

    window.addEventListener('beforeunload', () => {
        updateRowStyle(input);
        saveChanges();
    });

    function filterCards() {
        var input = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('tr').forEach(tr => {
            if (tr.textContent.toLowerCase().includes(input)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    }

    function sortTable(header, colIndex) {
        const table = header.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        const allHeaders = table.querySelectorAll('th.cursor-pointer');
        allHeaders.forEach(h => {
            if (h !== header) {
                h.querySelector('.icon').innerHTML = '';
                h.dataset.sortDir = 'asc';
            }
        });
        
        let dir = header.dataset.sortDir === 'asc' ? 1 : -1;
        header.dataset.sortDir = dir === 1 ? 'desc' : 'asc';
        
        rows.sort((a, b) => {
            let valA = a.cells[colIndex].dataset.sortValue || a.cells[colIndex].textContent.trim();
            let valB = b.cells[colIndex].dataset.sortValue || b.cells[colIndex].textContent.trim();
            if (!isNaN(valA) && !isNaN(valB)) {
                return dir * (parseFloat(valA) - parseFloat(valB));
            } else {
                return dir * valA.localeCompare(valB);
            }
        });
        
        rows.forEach(row => tbody.appendChild(row));
        
        header.querySelector('.icon').innerHTML = dir === 1 ? '&#x25B2;' : '&#x25BC;';
    }

    function add_toggle_button_event_listeners(buttons, type) {
        buttons.forEach(button => {
            button.addEventListener('click', async () => {
                const cardId = button.dataset.cardId;
                if (!cardId) {
                    return;
                }
                const formData = new FormData();
                formData.append(`${type}_toggle_${cardId}`, 'on');

                const csrfToken = getCookie('csrftoken');
                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken }
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        if (type === 'want') {
                            if (button.classList.contains('btn-success')) {
                                button.classList.remove('btn-success');
                                button.classList.add('btn-outline');
                                button.textContent = 'Wishlist';
                            } else {
                                button.classList.add('btn-success');
                                button.classList.remove('btn-outline');
                                button.textContent = 'Wishlisted!';
                            }
                            showIndicator('Wishlist updated!');
                        } else if (type === 'for_trade') {
                            if (button.classList.contains('btn-accent')) {
                                button.classList.remove('btn-accent');
                                button.classList.add('btn-outline');
                                button.textContent = 'Tradeable';
                            } else {
                                button.classList.add('btn-accent');
                                button.classList.remove('btn-outline');
                                button.textContent = 'For Trade!';
                            }
                            showIndicator('Trade status updated!');
                        } else if (type === 'favorite') {
                            if (button.classList.contains('btn-primary')) {
                                button.classList.remove('btn-primary');
                                button.classList.add('btn-outline');
                                button.textContent = 'Favorite';
                            } else {
                                button.classList.add('btn-primary');
                                button.classList.remove('btn-outline');
                                button.textContent = 'Favorited!'
                            }
                            showIndicator('Favorites updated!');
                        }
                    } else {
                        alert('Error: ' + (data.errors ? data.errors.join(', ') : 'Unknown'));
                    }
                } catch {
                    alert("Error processing button toggle.");
                }
            });
        });
    }

    const forTradeButtons = document.querySelectorAll('.for-trade-toggle');
    add_toggle_button_event_listeners(forTradeButtons, 'for_trade');
    const wishlistButtons = document.querySelectorAll('.wishlist-toggle');
    add_toggle_button_event_listeners(wishlistButtons, 'want');
    const favoriteButtons = document.querySelectorAll('.favorite-toggle');
    add_toggle_button_event_listeners(favoriteButtons, 'favorite')

    const smallImages = document.querySelectorAll('.card-small-img');
    const imageModal = document.getElementById('image-modal');
    const largeImage = document.getElementById('large-image');

    smallImages.forEach(img => {
        img.addEventListener('click', () => {
            const largeSrc = img.dataset.largeSrc;
            if (largeSrc) {
                largeImage.src = largeSrc;
                largeImage.alt = img.alt;
                imageModal.classList.remove('hidden');
                imageModal.classList.add('visible')
            
                rarity = img.dataset.rarity.toLowerCase();
                if (rarity.includes('diamond')) {
                    largeImage.classList.add('border-[oklch(74%_.16_232.661)]');
                    largeImage.classList.add('shadow-[oklch(74%_.16_232.661)]');
                } else if (rarity.includes('star')) {
                    largeImage.classList.add('border-[oklch(82%_.189_84.429)]');
                    largeImage.classList.add('shadow-[oklch(82%_.189_84.429)]');
                } else if (rarity.includes('shiny')) {
                    largeImage.classList.add('border-[oklch(65%_.241_354.308)]');
                    largeImage.classList.add('shadow-[oklch(65%_.241_354.308)]');
                } else if (rarity.includes('crown')) {
                    largeImage.classList.add('border-[oklch(71%_.194_13.428)]');
                    largeImage.classList.add('shadow-[oklch(71%_.194_13.428)]');
                } else {
                    largeImage.classList.add('border-neutral');
                    largeImage.classList.add('shadow-neutral');
                }
            }
        });
    });

    imageModal.addEventListener('click', (event) => {
            if (event.target === imageModal) {
                imageModal.classList.add('hidden');
                largeImage.src = '';
                
                const rarityClasses = [
                    'border-[oklch(74%_.16_232.661)]', 'shadow-[oklch(74%_.16_232.661)]',  // Diamond
                    'border-[oklch(82%_.189_84.429)]', 'shadow-[oklch(82%_.189_84.429)]',  // Star
                    'border-[oklch(65%_.241_354.308)]', 'shadow-[oklch(65%_.241_354.308)]',  // Shiny
                    'border-[oklch(71%_.194_13.428)]', 'shadow-[oklch(71%_.194_13.428)]',  // Crown
                    'border-neutral', 'shadow-neutral'  // Fallback
                ];

                rarityClasses.forEach(className => {
                    largeImage.classList.remove(className);
                });
            }
        });
</script>
{% endblock %}