{% extends "base.html" %}

{% block content %}
<div class="card bg-base-100 shadow-xl profile-card">
    <div class="card-body">

        <div id="boosters-container" class="flex flex-wrap justify-center gap-6">
            {% for set in sets %}
            {% if set.boosters.values|length > 0 %}
            <div class="raised-card-dark min-w-60 md:min-w-80 p-4 rounded-lg shadow-md flex flex-col items-center">
                {% if set.logo_path %}
                <img src="{{ set.logo.url }}" alt="{{ set.name }} Logo" class="w-24 md:w-36 lg:w-48 min-h-12 md:min-h-18 lg:min-h-24 py-auto mb-12">
                {% else %}
                <h2 class="text-xl font-semibold mb-2 h-12">{{ set.name }}</h2>
                {% endif %}
                <div class="flex flex-wrap justify-center gap-4">
                    {% for booster in set.boosters.all %}
                    <div class="tooltip tooltip-primary booster-card card-floating cursor-pointer border-5 border-transparent rounded-lg hover:border-primary" data-tip="{{ booster.name }}" data-id="{{ booster.id }}">
                        {% if booster.local_image_small %}
                        <img src="{{ booster.local_image_small.url }}" alt="{{ booster.name }}" class="w-32 h-auto rounded-lg" loading="lazy">
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-center">No boosters in this set.</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% empty %}
            <p>No sets available. Add some in the admin panel.</p>
            {% endfor %}
        </div>

        <form method="post" id="pack-form">
            {% csrf_token %}
            <div id="card-section" class="hidden mt-8">

                <div id="floating-preview" class="set-section flex flex-col gap-2 lg:gap-4 border-2 border-neutral justify-center items-center text-center sticky top-0 z-10 mb-2">
                    <div class="flex flex-col md:flex-row gap-2 lg:gap-6">
                        <div class="flex-col gap-2 ml-4 mt-2 hidden xl:flex">
                            <div id="booster-preview" class="text-center"></div>
                        </div>
                        <div>
                            <p class="text-xs mb-1 text-center">Slots 1-3 <span id="commons-count">(0/3)</span></p>
                            <div id="commons-selected" class="flex flex-row gap-2 justify-center">
                                <div class="ghost-card rounded-lg border-2 border-dashed border-gray-400 opactiy-50 w-20 h-28 lg:w-32 lg:h-44"></div>
                                <div class="ghost-card rounded-lg border-2 border-dashed border-gray-400 opactiy-50 w-20 h-28 lg:w-32 lg:h-44"></div>
                                <div class="ghost-card rounded-lg border-2 border-dashed border-gray-400 opactiy-50 w-20 h-28 lg:w-32 lg:h-44"></div>
                            </div>
                        </div>
                        <div class="flex flex-row gap-2">
                            <div>
                                <p class="text-xs mb-1 text-center">Slots 4-5 <span id="others-count">(0/2)</span></p>
                                <div id="others-selected" class="flex flex-row gap-2 justify-center">
                                    <div class="ghost-card rounded-lg border-2 border-dashed border-gray-400 opactiy-50 w-20 h-28 lg:w-32 lg:h-44"></div>
                                    <div class="ghost-card rounded-lg border-2 border-dashed border-gray-400 opactiy-50 w-20 h-28 lg:w-32 lg:h-44"></div>
                                </div>
                            </div>
                            <div id="sixth-preview" class="hidden">
                                <p class="text-xs mb-1 text-center">Opt 6th <span id="sixth-count">(0/1)</span></p>
                                <div id="sixth-selected" class="flex flex-row gap-2 justify-center">
                                    <div class="ghost-card rounded-lg border-2 border-dashed border-gray-400 opactiy-50 w-20 h-28 lg:w-32 lg:h-44"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button id="submit-pack" class="btn btn-md btn-accent w-full mt-4" disabled>Add to Collection</button>
                </div>

                <div class="flex flex-row gap-4">
                    <div class="flex-grow flex flex-col">
                        <div class="set-section p-4 bg-base-200 rounded-lg shadow-md mb-8">
                            <div class="flex-grow flex flex-col items-center">
                                <h3 class="text-xl font-semibold mb-2">Slots 1-3: One Diamond <span id="commons-count-preview" class="text-sm">(0/3)</span></h3>
                                <div id="commons-grid" class="flex flex-wrap gap-4 overflow-x-auto px-6 pb-8 pt-12 snap-x snap-mandatory overflow-visible justify-center"></div>
                            </div>
                        </div>

                        <div class="set-section p-4 bg-base-200 rounded-lg shadow-md mb-8">
                            <div class="flex-grow flex flex-col items-center">
                                <h3 class="text-xl font-semibold mb-2">Slots 4-5: Higher Rarities <span id="others-count-preview" class="text-sm">(0/2)</span></h3>
                                <div id="others-grid" class="flex flex-wrap gap-4 overflow-x-auto px-6 pb-8 pt-12 snap-x snap-mandatory overflow-visible justify-center"></div>
                            </div>
                        </div>

                        <div id="sixth-section" class="set-section p-4 bg-base-200 rounded-lg shadow-md">
                            <div class="flex-grow flex flex-col items-center">
                                <h3 class="text-xl font-semibold mb-2">Optional 6th Slot: Exclusives <span id="sixth-count-preview" class="text-sm">(0/2)</span></h3>
                                <div id="sixth-grid" class="flex flex-wrap gap-4 overflow-x-auto px-6 pb-8 pt-12 snap-x snap-mandatory overflow-visible justify-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <input type="hidden" name="booster_id" id="booster_id" value="">
            <input type="hidden" name="selected_cards" id="selected_cards" value="">
        </form>
    </div>
</div>

<script>
    let selectedBoosterId = null;
    let cardsData = { commons: [], others: [] };
    let selectedCommons = [];
    let selectedOthers = [];
    let selectedSixth = [];

    document.querySelectorAll('.booster-card').forEach(card => {
        card.addEventListener('click', function () {
            document.querySelectorAll('.booster-card').forEach(c => {
                    c.classList.remove('border-primary', 'scale-105');
                    c.classList.add('grayscale', 'border-transparent');
            });
            this.classList.add('border-primary', 'scale-105');
            this.classList.remove('grayscale', 'border-transparent');
            selectedBoosterId = this.dataset.id;
            proccedWithBooster(selectedBoosterId);
        });
    });

    function proccedWithBooster(boosterId) {
        fetch(`/get_booster_cards/?booster_id=${boosterId}`)
            .then(response => {
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                cardsData.commons = data.commons || [];
                cardsData.others = data.others || [];

                const previewDiv = document.getElementById('booster-preview');
                previewDiv.innerHTML = data.booster_image ? `<img src="${data.booster_image}" alt="Opened Booster" class="w-20 h-auto mb-2 mx-auto block"><p>Opening pack...</p>` : '';

                const commonsGrid = document.getElementById('commons-grid');
                commonsGrid.innerHTML = '';
                cardsData.commons.forEach(card => {
                    const cardDiv = `<div class="card card-collection w-3/4 sm:w-1/3 md:w-1/4 lg:w-32 bg-base-100 relative card-floating card-interactive rarity-diamond" data-tip="${card.name}" data-id="${card.id}">
                            <img src="${card.image}" alt="${card.name}" class="w-full h-auto rounded-lg" loading="lazy">
                        </div`;
                        commonsGrid.innerHTML += cardDiv;
                });

                const othersGrid = document.getElementById('others-grid');
                othersGrid.innerHTML = '';
                cardsData.others.forEach(card => {
                    let rarity = "";
                    if (card.rarity.toLowerCase().includes('diamond')) {
                        rarity = 'diamond';
                    } else if (card.rarity.toLowerCase().includes('star')) {
                        rarity = 'star';
                    } else if (card.rarity.toLowerCase().includes('shiny')) {
                        rarity = 'shiny';
                    } else if (card.rarity.toLowerCase().includes('crown')) {
                        rarity = 'crown';
                    }

                    const cardDiv = `<div class="card card-collection w-3/4 sm:w-1/3 md:w-1/4 lg:w-32 bg-base-100 relative card-floating card-interactive rarity-${rarity}" data-tip="${card.name}" data-id="${card.id}">
                            <img src="${card.image}" alt="${card.name}" class="w-full h-auto rounded-lg" loading="lazy">
                        </div`;
                        othersGrid.innerHTML += cardDiv;
                });

                if (data.has_sixth_option) {
                    const sixthGrid = document.getElementById('sixth-grid');
                    sixthGrid.innerHTML = '';
                    data.sixth.forEach(card => {
                        let rarity = "";
                        if (card.rarity.toLowerCase().includes('diamond')) {
                            rarity = 'diamond';
                        } else if (card.rarity.toLowerCase().includes('star')) {
                            rarity = 'star';
                        } else if (card.rarity.toLowerCase().includes('shiny')) {
                            rarity = 'shiny';
                        } else if (card.rarity.toLowerCase().includes('crown')) {
                            rarity = 'crown';
                        }
                        
                        const cardDiv = `<div class="card card-collection w-3/4 sm:w-1/3 md:w-1/4 lg:w-32 bg-base-100 relative card-floating card-interactive rarity-${rarity}" data-tip="${card.name}" data-id="${card.id}">
                                <img src="${card.image}" alt="${card.name}" class="w-full h-auto rounded-lg" loading="lazy">
                            </div>`;
                        sixthGrid.innerHTML += cardDiv;
                    });
                    document.getElementById('sixth-section').classList.remove('hidden');
                    document.getElementById('sixth-preview').classList.remove('hidden');
                } else {
                    document.getElementById('sixth-section').classList.add('hidden');
                    document.getElementById('sixth-preview').classList.add('hidden');
                }

                document.getElementById('boosters-container').classList.add('hidden');
                document.getElementById('card-section').classList.remove('hidden');

                selectedCommons = [];
                selectedOthers = [];
                updateCounts();
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            })
            .catch(error => alert(`Fetch failed: ${error.message}`));
    }

    document.getElementById('commons-grid').addEventListener('click', function(e) {
        const item = e.target.closest('div.card-collection');
        if (item) {
            const id = item.dataset.id;
            if (selectedCommons.length < 3) {
                selectedCommons.push(id);
            } else {
                alert('Max 3 for slots 1-3!');
            }
            updateSelectedPreview('commons');
            updateCounts();
        }
    });

    document.getElementById('others-grid').addEventListener('click', function(e) {
        const item = e.target.closest('div.card-collection');
        if (item) {
            const id = item.dataset.id;
            if (selectedOthers.length < 2) {
                selectedOthers.push(id);
            } else {
                alert('Max 2 for slots 4-5!');
            }
            updateSelectedPreview('others');
            updateCounts();
        }
    });

    document.getElementById('sixth-grid').addEventListener('click', function(e) {
        const item = e.target.closest('div.card-collection');
        if (item) {
            const id = item.dataset.id;
            if (selectedSixth.length < 1) {
                selectedSixth.push(id);
            } else {
                alert('Max 1 for optional 6th slot!');
            }
            updateSelectedPreview('sixth');
            updateCounts();
        }
    });

    function updateCounts() {
        document.getElementById('commons-count').textContent = `(${selectedCommons.length}/3)`;
        document.getElementById('commons-count-preview').textContent = `(${selectedCommons.length}/3)`;
        document.getElementById('others-count').textContent = `(${selectedOthers.length}/2)`;
        document.getElementById('others-count-preview').textContent = `(${selectedOthers.length}/2)`;
        document.getElementById('submit-pack').disabled = !(selectedCommons.length === 3 && selectedOthers.length === 2);

        document.getElementById('sixth-count').textContent = `(${selectedSixth.length}/1)`;
        document.getElementById('sixth-count-preview').textContent = `(${selectedSixth.length}/1)`;
    }

    document.querySelectorAll('.booster-card').forEach(card => {
        card.addEventListener('dblclick', function () {
            if (selectedBoosterId) {
                proccedWithBooster(selectedBoosterId)
            }
        })
    });

    function updateSelectedPreview(type) {
        if (type === 'sixth') {
            const previewInner = document.getElementById('sixth-selected');
            previewInner.innerHTML = '';
            const max = 1;
            selectedSixth.forEach(id => {
                const original = document.querySelector(`#sixth-grid > div[data-id="${id}"]`);
                if (original) {
                    const clone = original.cloneNode(true);
                    clone.classList.remove('card-floating', 'w-3/4', 'sm:w-1/3', 'md:w-1/4');
                    clone.classList.add('w-20', 'lg:w-32', 'h-28', 'lg:h-44');
                    previewInner.insertAdjacentHTML('beforeend', clone.outerHTML);
                }
            });
            const remaining = max - selectedSixth.length;
            for (let i = 0; i < remaining; i++) {
                const ghost = `<div class="ghost-card rounded-lg border-2 border-dashed border-gray-400 opactiy-50 w-20 h-28 lg:w-32 lg:h-44"></div>`;
                previewInner.insertAdjacentHTML('beforeend', ghost);
            }
        } else {
            const previewInner = document.getElementById(`${type}-selected`);
            previewInner.innerHTML = '';
            const selected = type === 'commons' ? selectedCommons : selectedOthers;
            const maxSlots = type === 'commons' ? 3 : 2;

            selected.forEach(id => {
                const original = document.querySelector(`#${type}-grid > div[data-id="${id}"]`);
                if (original) {
                    const clone = original.cloneNode(true);
                    clone.classList.remove('card-floating');
                    clone.classList.remove('w-3/4', 'sm:w-1/3', 'md:w-1/4');
                    clone.classList.add('w-20', 'lg:w-32', 'h-28', 'lg:h-44');
                    previewInner.insertAdjacentHTML('beforeend', clone.outerHTML);
                }
            });

            const remaining = maxSlots - selected.length;
            for (let i = 0; i < remaining; i++) {
                const ghost = `<div class="ghost-card rounded-lg border-2 border-dashed border-gray-400 opactiy-50 w-20 h-28 lg:w-32 lg:h-44"></div>`;
                previewInner.insertAdjacentHTML('beforeend', ghost);
            }
        }
    }

    document.getElementById('commons-selected').addEventListener('click', function(e) {
        const item = e.target.closest('div.card-collection');
        if (item) {
            const id = item.dataset.id;
            const index = selectedCommons.lastIndexOf(id);

            if (index > -1) {
                selectedCommons.splice(index, 1);
                updateSelectedPreview('commons');
                updateCounts();
            }
        }
    });

    document.getElementById('others-selected').addEventListener('click', function(e) {
        const item = e.target.closest('div.card-collection');
        if (item) {
            const id = item.dataset.id;
            const index = selectedOthers.lastIndexOf(id);

            if (index > -1) {
                selectedOthers.splice(index, 1);
                updateSelectedPreview('others');
                updateCounts();
            }
        }
    });

    document.getElementById('sixth-selected').addEventListener('click', function(e) {
        const item = e.target.closest('div.card-collection');
        if (item) {
            const id = item.dataset.id;
            const index = selectedSixth.indexOf(id);

            if (index > -1) {
                selectedSixth.splice(index, 1);
                updateSelectedPreview('sixth');
                updateCounts();
            }
        }
    });

    document.getElementById('submit-pack').addEventListener('click', function() {
        if (selectedCommons.length !== 3 || selectedOthers.length !== 2) return;

        document.getElementById('booster_id').value = selectedBoosterId;
        document.getElementById('selected_cards').value = JSON.stringify({
            commons: selectedCommons,
            others: selectedOthers,
            sixth: selectedSixth
        });

        document.getElementById('pack-form').submit();
    });
</script>
{% endblock %}