{% extends "base.html" %}
{% load custom_filters %}

{% block content %}
    <p>Base</p>
    <p class="hidden sm:block">Sm</p>
    <p class="hidden md:block">Md</p>
    <p class="hidden lg:block">Lg</p>
    <p class="hidden xl:block">Xl</p>
    <p class="hidden 2xl:block">2Xl</p>
<div class="card content-card">
    <div class="card-body">
        <h1 class="text-lg md:text-xl lg:text-2xl font-bold mb-4 border-b-2 border-base-300 pb-4">Welcome to Your Dashboard, {{ user.username }}</h1>
        <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

            <!-- Collection Stats -->
            <div class="card dashboard-card" data-card-id="total-stats">
                <button type="button" class="btn btn-xs btn-ghost dashboard-drag">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <div class="dashboard-body">
                    <h2 class="dashboard-title">Total Collection Stats</h2>

                    <div class="dashboard-divider"></div>

                    <p class="dashboard-label"></i>Unique Cards: <span class="dashboard-stat">{{ total_stats.total_unique }}</span> | Total Cards: <span class="dashboard-stat">{{ total_stats.total_quantity }}</span></p>
                    
                    <div class="dashboard-divider"></div>
                    
                    <p class="dashboard-label"><i class="fas fa-star mr-1 text-accent"></i>Base Cards: <span class="dashboard-stat">{{ total_stats.total_base }} / {{ total_stats.base_cards_count }} ({{ total_stats.base_completion }}%)</span></p>
                    <p class="dashboard-label"><i class="fas fa-star-half-alt mr-1 text-accent"></i>Rare Cards: <span class="dashboard-stat">{{ total_stats.total_rare }} / {{ total_stats.rare_cards_count }} ({{ total_stats.rare_completion }}%)</span></p>
                    <p class="dashboard-label"><i class="fas fa-crown mr-1 text-accent"></i>6th Slot Cards: <span class="dashboard-stat">{{ total_stats.total_exclusive }} / {{ total_stats.exclusive_cards_count }} ({{ total_stats.exclusive_completion }}%)</span></p>
                
                    <div class="dashboard-divider"></div>

                    {% for group in total_stats.grouped_rarities %}
                    <p class="dashboard-label"><span class="{{ group.group|lower }}-text">{% if group.group == 'Diamond' %}ðŸ’Ž{% elif group.group == 'Star' %}â˜…{% elif group.group == 'Shiny' %}âœ¨{% elif group.group == 'Crown' %}ðŸ‘‘{% endif %}
                        {{ group.group }}</span> Cards: <span class="dashboard-stat">{{ group.owned }} / {{ group.total }} ({{ group.completion }}%)</span></p>
                    {% endfor %}
                </div>
            </div>

            <!-- Set Breakdown -->

            <div class="card dashboard-card" data-card-id="set-breakdown">
                <button type="button" class="btn btn-xs btn-ghost dashboard-drag">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <div class="dashboard-body">
                    <h2 class="dashboard-title">Set Breakdown</h2>

                    <div class="dashboard-divider"></div>

                    <select id="set-breakdown-select" class="select select-md select-primary">
                        {% for set in all_sets %}
                        <option class="set-breakdown-option" value="{{ set.id }}">{{ set.name }}</option>
                        {% endfor %}
                    </select>

                    <div class="dashboard-divider mt-2"></div>

                    {% for set in set_breakdown %}
                    <div class="set-breakdown-display flex flex-col items-center hidden" data-set-id="{{ set.set_id }}">
                        <p class="dashboard-label">Total Collection: <span class="dashboard-stat">{{ set.owned }} / {{ set.total }} ({{ set.completion }}%)</span></p>
                        <progress class="progress progress-primary w-full mb-2" value="{{ set.completion }}" max="100"></progress>
                        {% for rarity in set_rarities|get_value:set.set_id %}
                        <p class="dashboard-label"><span class="{% if 'Diamond' in rarity.rarity %}diamond{% elif 'Star' in rarity.rarity %}star{% elif 'Shiny' in rarity.rarity %}shiny{% elif 'Crown' in rarity.rarity %}crown{% endif %}-text">
                            {% if 'Diamond' in rarity.rarity %}ðŸ’Ž{% elif 'Star' in rarity.rarity %}â˜…{% elif 'Shiny' in rarity.rarity %}âœ¨{% elif 'Crown' in rarity.rarity %}ðŸ‘‘{% endif %}
                            {{ rarity.rarity }}:</span> <span class="dashboard-stat">{{ rarity.owned }} / {{ rarity.total }} ({{ rarity.completion }}%)</span></p>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Pack Picker -->

            <div class="card dashboard-card min-h-120" data-card-id="pack-picker">
                <button type="button" class="btn btn-xs btn-ghost dashboard-drag">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <div class="dashboard-body flex flex-col justify-between h-full">
                    <div>
                        <h2 class="dashboard-title">Pack Picker</h2>

                        <div class="dashboard-divider"></div>

                        <table class="text-center border-separate border-spacing-x-2 xl:border-spacing-x-4 w-full">
                            <thead class="text-accent hover:bg-base-300 hover:scale-105">
                                <th class="border-b-2 border-base-300">Booster</th><th class="border-b-2 border-base-300">New Card%</th><th class="border-b-2 border-base-300">New Base%</th><th class="border-b-2 border-base-300">New Rare%</th>
                            </thead>
                            <tbody id="pack-picker-rows">
                                {% for booster in pack_picker %}
                                <tr class="font-semibold hover:bg-base-300 hover:scale-105 {% if forloop.counter0 >= 6%}hidden{% endif %}" data-page="{{ forloop.counter0|div:6 }}">
                                    <td class="text-primary">{{ booster.booster_name }}</td>
                                    <td>{{ booster.chance_new }}%</td>
                                    <td>{{ booster.base_chance_new }}%</td>
                                    <td>{{ booster.rare_chance_new }}%</td>
                                </tr>
                                <tr class="hover:bg-base-300 hover:scale-105 {% if forloop.counter0 >= 6%}hidden{% endif %}" data-page="{{ forloop.counter0|div:6 }}">
                                    <td class="text-accent font-semibold border-b-2 border-base-300">Missing:</td>
                                    <td class="dashboard-stat border-b-2 border-base-300">{{ booster.total_missing_count }}</td>
                                    <td class="dashboard-stat border-b-2 border-base-300">{{ booster.base_missing_count }}</td>
                                    <td class="dashboard-stat border-b-2 border-base-300">{{ booster.rare_missing_count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="pack-picker-tabs" class="flex justify-center mt-4 p-2 overflow-x-auto"></div>
                </div>                
            </div>
        </div>
    </div>
</div>

{{ pack_picker|json_script:"pack-picker-data" }}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const selector = document.getElementById('set-breakdown-select');
        const initialDisplay = document.querySelector(`.set-breakdown-display[data-set-id="${selector.value}"]`);
        initialDisplay.classList.remove('hidden');

        selector.addEventListener('change', function(e) {
            const all_displays = document.querySelectorAll('.set-breakdown-display');
            all_displays.forEach(display => {
                display.classList.add('hidden');
            });

            const setId = e.target.value;
            const selectedDisplay = document.querySelector(`.set-breakdown-display[data-set-id="${setId}"]`);
            selectedDisplay.classList.remove('hidden');
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const packPickerData = JSON.parse(document.getElementById('pack-picker-data').textContent);
        const rows = document.querySelectorAll('#pack-picker-rows tr');
        const tabsContainer = document.getElementById('pack-picker-tabs');
        const itemsPerPage = 6;
        const totalPages = Math.ceil(packPickerData.length / itemsPerPage);

        let currentPage = 0;

        function renderTabs() {
            tabsContainer.innerHTML = '';
            if (totalPages <= 1) return;
            const btnGroup = document.createElement('div');
            btnGroup.className = 'btn-group gap-2 lg:gap-0';
            for (let i = 0; i < totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = `btn btn-md lg:btn-sm btn-primary ${i === currentPage ? 'btn-active' : ''}`;
                btn.textContent = i + 1;
                btn.addEventListener('click', () => switchPage(i));
                btnGroup.appendChild(btn);
            }
            tabsContainer.appendChild(btnGroup);
        }

        function switchPage(page) {
            currentPage = page;
            rows.forEach(row => {
                const rowPage = parseInt(row.dataset.page);
                row.classList.toggle('hidden', rowPage !== page);
            });
            tabsContainer.querySelectorAll('.btn').forEach((btn, i) => {
                btn.classList.toggle('btn-active', i === page);
            });
            console.log('Switched to page:', page);
        }

        renderTabs();
    });
</script>
{% endblock %}