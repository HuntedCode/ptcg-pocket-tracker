{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block content %}
        <p>Base</p>
        <p class="hidden sm:block">Sm</p>
        <p class="hidden md:block">Md</p>
        <p class="hidden lg:block">Lg</p>
        <p class="hidden xl:block">Xl</p>
        <p class="hidden 2xl:block">2Xl</p>

<div class="container mx-auto px-4">
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            {% if not request.user.profile.is_trading_active %}
            <div class="max-w-full text-center">
                <div class="flex flex-row items-center justify-center mb-2">
                    <h1 class="text-3xl font-bold">Propose A Trade</h1><img src="{% static '/images/icons/swap.png' %}" class="w-10 h-10 ml-2" />
                </div>
                <p class="text-md font-semibold mb-4">You don't have trading enabled! Head to your profile to set yourself as open to trading!</p>
            </div>
            {% if message %}
            <div class="alert alert-info shadow-lg">
                <div>
                    <span>{{ message }}</span>
                </div>
            </div>
            {% endif %}
            {% else %}
            <div class="max-w-full text-center border-b-2 border-base-300 mb-6">
                <div class="flex flex-row items-center justify-center mb-2">
                    <h1 class="text-4xl text-primary font-bold">Propose A Trade</h1><img src="{% static '/images/icons/swap.png' %}" class="w-10 h-10 ml-2" />
                </div>
                <p class="text-md font-semibold mb-4">Select a card from your wishlist to generate potential trade matches!</p>
            </div>
            {% if message %}
            <div class="alert alert-info shadow-lg">
                <div>
                    <span>{{ message }}</span>
                </div>
            </div>
            {% endif %}

            {% if form.fields.wanted_card.queryset.exists %}
            <form method="post" class="form-control w-full max-w-md mx-auto mb-6">
                {% csrf_token %}
                <label class="label" for="{{ form.wanted_card.id_for_label }}">
                    <span class="label-text font-semibold text-lg text-primary">Select A Card To Trade For:</span>
                </label>
                {{ form.wanted_card }}
                <button class="btn btn-primary mt-4" type="submit" {% if not form.fields.wanted_card.queryset.exists %}disabled{% endif %}>Generate Trades</button>
            </form>
            {% else %}
            <div class="alert alert-info">No items on your wishlist! Add some to start trading!</div>
            {% endif %}

            {% if matches %}
            <form method="post" action="{% url 'propose_trades' %}" id="propose-form">
                {% csrf_token %}
                <div class="overflow-x-auto mb-4">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th><label>Select</label></th>
                                <th>Trader</th>
                                <th>You Receive</th>
                                <th>You Offer</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for match in matches %}
                            <tr>
                                <td><input type="checkbox" class="checkbox checkbox-primary" name="selected_matches" value="{{ match.recipient.id }}|{{ match.received_card.id }}|{{ match.offered_card.id }}" /></td>
                                <td>{{ match.anon_name }}</td>
                                <td>{{ match.received_card.name }} ({{ match.received_card.tcg_id }})</td>
                                <td>
                                    {{ match.offered_card.name }} ({{ match.offered_card.tcg_id }})
                                    {% if match.is_same_set %}<div class="badge badge-primary ml-2">Same Set</div>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button class="btn btn-accent mt-4" type="submit" id="propose-btn" disabled>Send Selected Trade Requests!</button>
                </div>
            </form>
            {% else %}
            {% if request.method == 'POST' %}
            <div class="alert alert-warning mt-4">No matches found for this card. Try another from your wishlist or check back later.</div>
            {% endif %}
            {% endif %}
            {% endif %}

            {% if request.user.profile.is_trading_active %}
            <div class="set-section mb-8">
                <h3 class="text-xl font-bold mb-6">Outgoing Slots ({{ slots.outgoing_occupied }} / {{ slots.base_slots }} used)</h3>
                <div class="grid grid cols-1 md:grid-cols-3 gap-8 mb-6 items-center">

                    {% for accepted in slots.outgoing_accepteds %}
                    <div class="raised-card cursor-pointer p-4 rounded-lg shadow-md flex flex-col items-center hover:scale-105" onclick="document.location='{% url 'trade_detail' accepted.id %}';">
                        <div class="card-body p-2">
                            <p class="text-center text-xl text-accent font-bold"><span class="p-2 hover:bg-neutral hover:text-primary-content hover:rounded-md">Outgoing Trade Slot #{{ forloop.counter }}</span></p>
                            <p class="text-center text-xl text-accent-content font-bold p-2"><span class="badge badge-xl badge-success">Accepted!</span></p>
                            <div class="flex justify-center items-center">
                                <div class="text-center flex flex-col items-center">
                                    <p class="text-xl text-primary font-bold mb-10">You Send:</p>
                                    {% with rarity_lower=accepted.offered_card.rarity|lower %}
                                    <div class="card w-32 bg-base-100 relative card-floating card-interactive
                                    {% if 'diamond' in rarity_lower %}rarity-diamond
                                    {% elif 'star' in rarity_lower %}rarity-star
                                    {% elif 'shiny' in rarity_lower %}rarity-shiny
                                    {% elif 'crown' in rarity_lower %}rarity-crown
                                    {% endif %}" data-card-id="{{ accepted.offered_card.id }}" data-rarity="{{ accepted.offered_card.rarity }}" role="button" tabindex="0">
                                    {% endwith %}
                                        <div class="tooltip" data-tip="{{ accepted.offered_card.name }} - {{ accepted.offered_card.rarity }}">
                                            <figure>
                                                <img src="{% static accepted.offered_card.local_image_small %}" alt="{{ accepted.offered_card.name }}" class="card-small-img w-full h-44 object-cover" data-large-src="{{ accepted.offered_card.image_base }}/high.png" data-rarity="{{ accepted.offered_card.rarity }}" loading="lazy">
                                            </figure>
                                        </div>
                                    </div>
                                    <img src="{% static accepted.offered_card.card_set.logo_path %}" alt="{{ accepted.offered_card.card_set.name }} logo" class="h-8 mt-2">
                                </div>

                                <img src="{% static '/images/icons/swap.png' %}" class="w-20 h-20 mx-4" />

                                <div class="text-center flex flex-col items-center">
                                    <p class="text-xl text-success font-bold mb-10">You Receive:</p>
                                    {% with rarity_lower=accepted.received_card.rarity|lower %}
                                    <div class="card w-32 bg-base-100 relative card-floating card-interactive
                                    {% if 'diamond' in rarity_lower %}rarity-diamond
                                    {% elif 'star' in rarity_lower %}rarity-star
                                    {% elif 'shiny' in rarity_lower %}rarity-shiny
                                    {% elif 'crown' in rarity_lower %}rarity-crown
                                    {% endif %}" data-card-id="{{ accepted.received_card.id }}" data-rarity="{{ accepted.received_card.rarity }}" role="button" tabindex="0">
                                    {% endwith %}
                                        <div class="tooltip" data-tip="{{ accepted.received_card.name }} - {{ accepted.received_card.rarity }}">
                                            <figure>
                                                <img src="{% static accepted.received_card.local_image_small %}" alt="{{ accepted.received_card.name }}" class="card-small-img w-full h-44 object-cover" data-large-src="{{ accepted.received_card.image_base }}/high.png" data-rarity="{{ accepted.received_card.rarity }}" loading="lazy">
                                            </figure>
                                        </div>
                                    </div>
                                    <img src="{% static accepted.received_card.card_set.logo_path %}" alt="{{ accepted.received_card.card_set.name }} logo" class="h-8 mt-2">
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% for pending in slots.outgoing_pendings %}
                    <div class="raised-card cursor-pointer min-w-80 p-4 rounded-lg shadow-md flex flex-col items-center hover:scale-105" onclick="document.location='{% url 'trade_detail' pending.id %}';">
                        <div class="card-body p-2">
                            <p class="text-center text-xl text-accent font-bold"><span class="p-2 hover:bg-neutral hover:text-primary-content hover:rounded-md">Outgoing Trade Slot #{{ slots.outgoing_accepteds|length|add:forloop.counter }}</span></p>
                            <p class="text-center text-xl text-accent-content font-bold p-2"><span class="badge badge-xl badge-primary">Pending...</span></p>
                            <div class="flex justify-center items-center">
                                <div class="text-center flex flex-col items-center">
                                    <p class="text-xl text-primary font-bold mb-10">You Send:</p>
                                    {% with rarity_lower=pending.offered_card.rarity|lower %}
                                    <div class="card w-32 bg-base-100 relative card-floating card-interactive
                                    {% if 'diamond' in rarity_lower %}rarity-diamond
                                    {% elif 'star' in rarity_lower %}rarity-star
                                    {% elif 'shiny' in rarity_lower %}rarity-shiny
                                    {% elif 'crown' in rarity_lower %}rarity-crown
                                    {% endif %}" data-card-id="{{ pending.offered_card.id }}" data-rarity="{{ pending.offered_card.rarity }}" role="button" tabindex="0">
                                    {% endwith %}
                                        <div class="tooltip" data-tip="{{ pending.offered_card.name }} - {{ pending.offered_card.rarity }}">
                                            <figure>
                                                <img src="{% static pending.offered_card.local_image_small %}" alt="{{ pending.offered_card.name }}" class="card-small-img w-full h-44 object-cover" data-large-src="{{ pending.offered_card.image_base }}/high.png" data-rarity="{{ pending.offered_card.rarity }}" loading="lazy">
                                            </figure>
                                        </div>
                                    </div>
                                    <img src="{% static pending.offered_card.card_set.logo_path %}" alt="{{ pending.offered_card.card_set.name }} logo" class="h-8 mt-2">
                                </div>

                                <img src="{% static '/images/icons/swap.png' %}" class="w-20 h-20 mx-4" />

                                <div class="text-center flex flex-col items-center">
                                    <p class="text-xl text-success font-bold mb-10">You Receive:</p>
                                    {% with rarity_lower=pending.received_card.rarity|lower %}
                                    <div class="card w-32 bg-base-100 relative card-floating card-interactive
                                    {% if 'diamond' in rarity_lower %}rarity-diamond
                                    {% elif 'star' in rarity_lower %}rarity-star
                                    {% elif 'shiny' in rarity_lower %}rarity-shiny
                                    {% elif 'crown' in rarity_lower %}rarity-crown
                                    {% endif %}" data-card-id="{{ pending.received_card.id }}" data-rarity="{{ pending.received_card.rarity }}" role="button" tabindex="0">
                                    {% endwith %}
                                        <div class="tooltip" data-tip="{{ pending.received_card.name }} - {{ pending.received_card.rarity }}">
                                            <figure>
                                                <img src="{% static pending.received_card.local_image_small %}" alt="{{ pending.received_card.name }}" class="card-small-img w-full h-44 object-cover" data-large-src="{{ pending.received_card.image_base }}/high.png" data-rarity="{{ pending.received_card.rarity }}" loading="lazy">
                                            </figure>
                                        </div>
                                    </div>
                                    <img src="{% static pending.received_card.card_set.logo_path %}" alt="{{ pending.received_card.card_set.name }} logo" class="h-8 mt-2">
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% for i in slots.outgoing_free|times %}
                    <div class="raised-card card-interactive relative w-64 h-80 border-2 border-dashed rounded-lg shadow-md mx-auto">
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-4 text-center">
                            <svg class="w-12 h-12 mb-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>  <!-- Plus icon for "add" -->
                            <p class="font-bold text-lg">Free Slot</p>
                            <p class="text-sm text-gray-600">Ready for a new trade proposal!</p>
                        </div>
                    </div>
                    {% endfor %}

                    {% if not request.user.profile.is_premium %}
                    {% for i in 6|times %}
                    <div class="raised-card-disabled{% if request.user.profile.dark_mode %}-dark{% endif %} relative w-64 h-80 cursor-not-allowed mx-auto">
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-4 text-center">
                            <img src="{% static '/images/icons/chest.png' %}" class="w-12 h-12" />
                            <p class="font-bold text-lg">Locked Slot</p>
                            <p class="text-sm text-gray-500">Upgrade to Premium to unlock more slots!</p>
                            <a href="" class="btn btn-sm btn-accent mt-2">Upgrade Now</a>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            <div class="set-section">
                <h3 class="text-xl font-bold mb-6">Incoming Slots ({{ slots.incoming_occupied }} / {{ slots.base_slots }} used)</h3>
                <div class="grid grid cols-1 md:grid-cols-3 gap-8 mb-6 items-center">

                    {% for accepted in slots.incoming_accepteds %}
                    <div class="raised-card cursor-pointer min-w-80 p-4 rounded-lg shadow-md flex flex-col items-center hover:scale-105" onclick="document.location='{% url 'trade_detail' accepted.id %}';">
                        <div class="card-body p-2">
                            <p class="text-center text-xl text-accent font-bold"><span class="p-2 hover:bg-neutral hover:text-primary-content hover:rounded-md">Incoming Trade Slot #{{ forloop.counter }}</span></p>
                            <p class="text-center text-xl text-accent-content font-bold p-2"><span class="badge badge-xl badge-success">Accepted!</span></p>
                            <div class="flex justify-center items-center">
                                <div class="text-center flex flex-col items-center">
                                    <p class="text-xl text-primary font-bold mb-10">You Send:</p>
                                    {% with rarity_lower=accepted.offered_card.rarity|lower %}
                                    <div class="card w-32 bg-base-100 relative card-floating card-interactive
                                    {% if 'diamond' in rarity_lower %}rarity-diamond
                                    {% elif 'star' in rarity_lower %}rarity-star
                                    {% elif 'shiny' in rarity_lower %}rarity-shiny
                                    {% elif 'crown' in rarity_lower %}rarity-crown
                                    {% endif %}" data-card-id="{{ accepted.offered_card.id }}" data-rarity="{{ accepted.offered_card.rarity }}" role="button" tabindex="0">
                                    {% endwith %}
                                        <div class="tooltip" data-tip="{{ accepted.offered_card.name }} - {{ accepted.offered_card.rarity }}">
                                            <figure>
                                                <img src="{% static accepted.offered_card.local_image_small %}" alt="{{ accepted.offered_card.name }}" class="card-small-img w-full h-44 object-cover" data-large-src="{{ accepted.offered_card.image_base }}/high.png" data-rarity="{{ accepted.offered_card.rarity }}" loading="lazy">
                                            </figure>
                                        </div>
                                    </div>
                                    <img src="{% static accepted.offered_card.card_set.logo_path %}" alt="{{ accepted.offered_card.card_set.name }} logo" class="h-8 mt-2">
                                </div>

                                <img src="{% static '/images/icons/swap.png' %}" class="w-20 h-20 mx-4" />

                                <div class="text-center flex flex-col items-center">
                                    <p class="text-xl text-success font-bold mb-10">You Receive:</p>
                                    {% with rarity_lower=accepted.received_card.rarity|lower %}
                                    <div class="card w-32 bg-base-100 relative card-floating card-interactive
                                    {% if 'diamond' in rarity_lower %}rarity-diamond
                                    {% elif 'star' in rarity_lower %}rarity-star
                                    {% elif 'shiny' in rarity_lower %}rarity-shiny
                                    {% elif 'crown' in rarity_lower %}rarity-crown
                                    {% endif %}" data-card-id="{{ accepted.received_card.id }}" data-rarity="{{ accepted.received_card.rarity }}" role="button" tabindex="0">
                                    {% endwith %}
                                        <div class="tooltip" data-tip="{{ accepted.received_card.name }} - {{ accepted.received_card.rarity }}">
                                            <figure>
                                                <img src="{% static accepted.received_card.local_image_small %}" alt="{{ accepted.received_card.name }}" class="card-small-img w-full h-44 object-cover" data-large-src="{{ accepted.received_card.image_base }}/high.png" data-rarity="{{ accepted.received_card.rarity }}" loading="lazy">
                                            </figure>
                                        </div>
                                    </div>
                                    <img src="{% static accepted.received_card.card_set.logo_path %}" alt="{{ accepted.received_card.card_set.name }} logo" class="h-8 mt-2">
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% for pending in slots.incoming_pendings %}
                    <div class="raised-card cursor-pointer min-w-80 p-4 rounded-lg shadow-md flex flex-col items-center hover:scale-105" onclick="document.location='{% url 'trade_detail' pending.id %}';">
                        <div class="card-body p-2">
                            <p class="text-center text-xl text-accent font-bold"><span class="p-2 hover:bg-neutral hover:text-primary-content hover:rounded-md">Incoming Trade Slot #{{ slots.incoming_accepteds|length|add:forloop.counter }}</span></p>
                            <p class="text-center text-xl text-accent-content font-bold p-2"><span class="badge badge-xl badge-primary">Pending...</span></p>
                            <div class="flex justify-center items-center">
                                <div class="text-center flex flex-col items-center">
                                    <p class="text-xl text-success font-bold mb-10">You Send:</p>
                                    {% with rarity_lower=pending.received_card.rarity|lower %}
                                    <div class="card w-32 bg-base-100 relative card-floating card-interactive
                                    {% if 'diamond' in rarity_lower %}rarity-diamond
                                    {% elif 'star' in rarity_lower %}rarity-star
                                    {% elif 'shiny' in rarity_lower %}rarity-shiny
                                    {% elif 'crown' in rarity_lower %}rarity-crown
                                    {% endif %}" data-card-id="{{ pending.received_card.id }}" data-rarity="{{ pending.received_card.rarity }}" role="button" tabindex="0">
                                    {% endwith %}
                                        <div class="tooltip" data-tip="{{ pending.received_card.name }} - {{ pending.received_card.rarity }}">
                                            <figure>
                                                <img src="{% static pending.received_card.local_image_small %}" alt="{{ pending.received_card.name }}" class="card-small-img w-full h-44 object-cover" data-large-src="{{ pending.received_card.image_base }}/high.png" data-rarity="{{ pending.received_card.rarity }}" loading="lazy">
                                            </figure>
                                        </div>
                                    </div>
                                    <img src="{% static pending.received_card.card_set.logo_path %}" alt="{{ pending.received_card.card_set.name }} logo" class="h-8 mt-2">
                                </div>

                                <img src="{% static '/images/icons/swap.png' %}" class="w-20 h-20 mx-4" />
                                
                                <div class="text-center flex flex-col items-center">
                                    <p class="text-xl text-primary font-bold mb-10">You Receive:</p>
                                    {% with rarity_lower=pending.offered_card.rarity|lower %}
                                    <div class="card w-32 bg-base-100 relative card-floating card-interactive
                                    {% if 'diamond' in rarity_lower %}rarity-diamond
                                    {% elif 'star' in rarity_lower %}rarity-star
                                    {% elif 'shiny' in rarity_lower %}rarity-shiny
                                    {% elif 'crown' in rarity_lower %}rarity-crown
                                    {% endif %}" data-card-id="{{ pending.offered_card.id }}" data-rarity="{{ pending.offered_card.rarity }}" role="button" tabindex="0">
                                    {% endwith %}
                                        <div class="tooltip" data-tip="{{ pending.offered_card.name }} - {{ pending.offered_card.rarity }}">
                                            <figure>
                                                <img src="{% static pending.offered_card.local_image_small %}" alt="{{ pending.offered_card.name }}" class="card-small-img w-full h-44 object-cover" data-large-src="{{ pending.offered_card.image_base }}/high.png" data-rarity="{{ pending.offered_card.rarity }}" loading="lazy">
                                            </figure>
                                        </div>
                                    </div>
                                    <img src="{% static pending.offered_card.card_set.logo_path %}" alt="{{ pending.offered_card.card_set.name }} logo" class="h-8 mt-2">
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% for i in slots.incoming_free|times %}
                    <div class="raised-card card-interactive relative w-64 h-80 border-2 border-dashed rounded-lg shadow-md mx-auto">
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-4 text-center">
                            <svg class="w-12 h-12 mb-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>  <!-- Plus icon for "add" -->
                            <p class="font-bold text-lg">Free Slot</p>
                            <p class="text-sm text-gray-600">Ready for a new trade proposal!</p>
                        </div>
                    </div>
                    {% endfor %}

                    {% if not request.user.profile.is_premium %}
                    {% for i in 6|times %}
                    <div class="raised-card-disabled{% if request.user.profile.dark_mode %}-dark{% endif %} relative w-64 h-80 cursor-not-allowed mx-auto">
                        <div class="absolute inset-0 flex flex-col items-center justify-center p-4 text-center">
                            <img src="{% static '/images/icons/chest.png' %}" class="w-12 h-12" />
                            <p class="font-bold text-lg">Locked Slot</p>
                            <p class="text-sm text-gray-500">Upgrade to Premium to unlock more slots!</p>
                            <a href="" class="btn btn-sm btn-accent mt-2">Upgrade Now</a>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).length > 0;
            document.getElementById('propose-btn').disabled = !checked;
        });
    });
</script>

{% endblock %}