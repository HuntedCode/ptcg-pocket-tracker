{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="card content-card">
    <div class="card-body">

        {% if request.user == profile.user %}
        <div class="flex flex-col items-center justify-center pb-6">
            <h1 class="text-2xl md:text-4xl font-bold text-primary">Your Wishlist!</h1>
            <div class="mt-4 flex flex-col lg:flex-row items-center gap-2 w-50 md:w-100 lg:w-175">
                <input type="text" id="share-url" value="{{ share_url }}" class="input input-primary w-full" readonly>  <!-- DaisyUI input -->
                <button id="copy-btn" class="btn btn-primary">Copy Link</button>
            </div>
        </div>
        {% else %}
        <div class="flex flex-col items-center justify-center pb-6">
            <h1 class="text-2xl md:text-4xl font-bold text-primary">{{ profile.user.username }}'s Wishlist!</h1>
            <p class="text-sm md:text-md justify-center font-semibold">(Highlighted card: you own enough copies to trade!)</p>
        </div>
        {% endif %}
        {% if not sorted_sets %}
        <div class="alert alert-info shadow-lg">
            <div class="flex flex-row items-center">
                <img src="{% static 'images/icons/pokeball-open-favicon.png' %}" alt="Pokeball Logo" class="w-8 h-8 mr-2">
                <p class="font-semibold">Your wishlist is empty! Head to your collection to add some cards!</p>
            </div>
        </div>
        {% else %}
        {% for set_obj, wants in sorted_sets %}
        <div class="mb-8 set-section">
            <div class="flex justify-between items-center mb-4 p-2">
                <h2 class="text-lg md:text-2xl font-semibold mb-4 flex flex-wrap justify-start items-center">
                    <img src="{% static set_obj.logo_path %}" alt="{{ set_obj.name }} logo" class="h-6 md:h-8 mr-2">
                    {{ set_obj.name }}
                    <span class="ml-2 text-xs md:text-sm text-neutral">({{ wants|length }} cards)</span>
                </h2>
                <button class="btn btn-sm bg-base-200 toggle-btn hover:bg-primary hover:text-primary-content" data-target="cards-{{ set_obj.id }}">▼</button>
            </div>
            <div id="cards-{{ set_obj.id }}" class="flex flex-wrap gap-4 px-4 md:px-6 pb-8 pt-8 md:pt-12 overflow-visible justify-center">
                {% for want_item in wants %}
                {% if profile.user == request.user %}
                {% with want=want_item rarity_lower=want_item.card.rarity|lower %}
                <div class="card card-collection w-3/4 sm:w-1/3 md:w-1/4 lg:w-32 bg-base-100 relative card-floating card-interactive
                {% if 'diamond' in rarity_lower %}rarity-diamond
                {% elif 'star' in rarity_lower %}rarity-star
                {% elif 'shiny' in rarity_lower %}rarity-shiny
                {% elif 'crown' in rarity_lower %}rarity-crown
                {% endif %}" data-card-id="{{ want.card.id }}" role="button" tabindex="0">
                    <div class="tooltip" data-tip="{{ want.card.name }} - {{ want.card.rarity }}">
                        <figure>
                            <img src="{% static want.card.local_image_small %}" alt="{{ want.card.name }}" class="card-small-img w-full h-auto object-cover grayscale hover:grayscale-0" data-large-src="{{ want.card.image_base }}/high.png" data-rarity="{{ want.card.rarity }}" loading="lazy">
                        </figure>
                    </div>
                    <form method="post" class="absolute top-1 right-1" data-ajax-form>
                        {% csrf_token %}
                        <input type="hidden" name="remove_want_{{ want.card.id }}" value="true">
                        <button type="submit" class="btn btn-circle btn-sm lg:btn-xs bg-error shadow-sm shadow-neutral text-white hover:bg-error-dark remove-overlay">
                            -
                        </button>
                    </form>
                </div>
                {% endwith %}
                {% else %}
                {% with want=want_item.0 rarity_lower=want_item.0.card.rarity|lower %}
                <div class="card card-collection w-3/4 sm:w-1/3 md:w-1/4 lg:w-32 bg-base-100 relative card-floating card-interactive
                {% if 'diamond' in rarity_lower %}rarity-diamond
                {% elif 'star' in rarity_lower %}rarity-star
                {% elif 'shiny' in rarity_lower %}rarity-shiny
                {% elif 'crown' in rarity_lower %}rarity-crown
                {% endif %}" data-card-id="{{ want.card.id }}" role="button" tabindex="0">
                    <div class="tooltip" data-tip="{{ want.card.name }} - {{ want.card.rarity }}">
                        <figure>
                            <img src="{% static want.card.local_image_small %}" alt="{{ want.card.name }}" class="card-small-img w-full h-auto object-cover{% if not want_item.1 %} grayscale hover:grayscale-0{% endif %}" data-large-src="{{ want.card.image_base }}/high.png" data-rarity="{{ want.card.rarity }}" loading="lazy">
                        </figure>
                    </div>
                </div>
                {% endwith %}
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% endif %}

        {% if errors %}
            <div class="alert alert-error mt-4">
                {% for error in errors %}
                    <p>{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
    </div>
</div>
<div id="image-modal" class="fixed inset-0 flex items-center justify-center backdrop-blur-md z-50 cursor-pointer hidden">
    <img id="large-image" scr="" alt="Large card image" class="max-w-[75%] max-h-[75%] border-8 shadow-2xl rounded-xl">
</div>

<script>
    forms = document.querySelectorAll('[data-ajax-form]')
    if (forms.length > 0) {
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const xhr = new XMLHttpRequest();
                xhr.open('POST', window.location.href);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.status === 'success') {
                            const cardElem = form.closest('.card');
                            const setSection = cardElem.closest('.set-section');
                            const flexContainer = setSection.querySelector('.flex');
                            const countSpan = setSection.querySelector('.text-sm.text-gray-500');

                            cardElem.classList.add('fade-out');
                            setTimeout(() => {
                                cardElem.remove();

                                if (countSpan) {
                                    let currentText = countSpan.textContent;
                                    let match = currentText.match(/\((\d+) cards\)/);
                                    if (match) {
                                        let newCount = parseInt(match[1]) - 1;
                                        if (newCount === 0) {
                                            setSection.remove();
                                        } else {
                                            countSpan.textContent = `(${newCount} cards)`;
                                        }
                                    }
                                }
                            }, 500);
                        } else {
                            alert('Error: ' + response.errors.join('\n'));
                        }
                    }
                };
                xhr.send(new FormData(form));
            });
        });
    }

    const smallImages = document.querySelectorAll('.card-small-img');
    const imageModal = document.getElementById('image-modal');
    const largeImage = document.getElementById('large-image');

    smallImages.forEach(img => {
        img.addEventListener('click', function(e) {
            if (e.target.closest('form')) return;

            const largeSrc = img.dataset.largeSrc;
            if (largeSrc) {
                largeImage.src = largeSrc;
                largeImage.alt = img.alt;
                imageModal.classList.remove('hidden');
                imageModal.classList.add('visible')
            
                rarity = img.dataset.rarity.toLowerCase();
                if (rarity.includes('diamond')) {
                    largeImage.classList.add('border-[oklch(74%_.16_232.661)]');
                    largeImage.classList.add('shadow-[oklch(74%_.16_232.661)]');
                } else if (rarity.includes('star')) {
                    largeImage.classList.add('border-[oklch(82%_.189_84.429)]');
                    largeImage.classList.add('shadow-[oklch(82%_.189_84.429)]');
                } else if (rarity.includes('shiny')) {
                    largeImage.classList.add('border-[oklch(65%_.241_354.308)]');
                    largeImage.classList.add('shadow-[oklch(65%_.241_354.308)]');
                } else if (rarity.includes('crown')) {
                    largeImage.classList.add('border-[oklch(71%_.194_13.428)]');
                    largeImage.classList.add('shadow-[oklch(71%_.194_13.428)]');
                } else {
                    largeImage.classList.add('border-neutral');
                    largeImage.classList.add('shadow-neutral');
                }
            }
        });
    });

    imageModal.addEventListener('click', (event) => {
        if (event.target === imageModal) {
            imageModal.classList.add('hidden');
            largeImage.src = '';
            
            const rarityClasses = [
                'border-[oklch(74%_.16_232.661)]', 'shadow-[oklch(74%_.16_232.661)]',  // Diamond
                'border-[oklch(82%_.189_84.429)]', 'shadow-[oklch(82%_.189_84.429)]',  // Star
                'border-[oklch(65%_.241_354.308)]', 'shadow-[oklch(65%_.241_354.308)]',  // Shiny
                'border-[oklch(71%_.194_13.428)]', 'shadow-[oklch(71%_.194_13.428)]',  // Crown
                'border-neutral', 'shadow-neutral'  // Fallback
            ];

            rarityClasses.forEach(className => {
                largeImage.classList.remove(className);
            });
        }
    });

    copyBtn = document.getElementById('copy-btn')
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            const urlInput = document.getElementById('share-url');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);

            navigator.clipboard.writeText(urlInput.value)
                .then(() => {
                    const btn = this;
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => { btn.textContent = originalText; }, 2000);
                })
                .catch(err => {
                    console.error('Copy failed:', err);
                    alert('Copy failed-please select and copy manually.');
                });
        });
    }

    document.querySelectorAll('.toggle-btn').forEach(button => {
        const targetId = button.dataset.target;
        const cardsDiv = document.getElementById(targetId);

        button.addEventListener('click', function() {
            cardsDiv.classList.toggle('hidden');
            if (cardsDiv.classList.contains('hidden')) {
                this.textContent = '▲';
            } else {
                this.textContent = '▼';
            }
        });
    });
</script>
{% endblock %}